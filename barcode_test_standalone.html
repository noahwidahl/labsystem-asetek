<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standalone Barcode Scanner Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .test-pass {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .console-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1><i class="fas fa-barcode me-2"></i>Barcode Scanner Diagnostic Test</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-check-circle me-2"></i>Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal me-2"></i>Console Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="consoleOutput" class="console-output"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-play me-2"></i>Manual Test</h5>
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                            <input type="text" class="form-control" id="testBarcodeInput" 
                                   placeholder="Test barcode (e.g., BC1-1751138774-1, CNT-12, SMP-123)" 
                                   value="BC1-1751138774-1">
                            <button class="btn btn-primary" onclick="testBarcodeScan()">
                                <i class="fas fa-search me-1"></i>Test Scan
                            </button>
                        </div>
                        <div id="scanTestResult"></div>
                        
                        <div class="mt-3">
                            <h6>Test API Call (without scanner):</h6>
                            <button class="btn btn-secondary" onclick="testAPICall()">
                                <i class="fas fa-globe me-1"></i>Test API Endpoint
                            </button>
                            <div id="apiTestResult" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Console logging capture
        const consoleOutput = document.getElementById('consoleOutput');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function logToOutput(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const prefix = {
                'log': '[LOG]',
                'error': '[ERROR]',
                'warn': '[WARN]'
            }[type] || '[INFO]';
            
            consoleOutput.textContent += `${timestamp} ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            logToOutput('log', ...args);
            return originalLog.apply(console, arguments);
        };
        
        console.error = function(...args) {
            logToOutput('error', ...args);
            return originalError.apply(console, arguments);
        };
        
        console.warn = function(...args) {
            logToOutput('warn', ...args);
            return originalWarn.apply(console, arguments);
        };
        
        // Test results tracking
        const testResults = [];
        
        function addTest(name, passed, message) {
            testResults.push({ name, passed, message });
            updateTestDisplay();
        }
        
        function updateTestDisplay() {
            const resultsDiv = document.getElementById('testResults');
            let html = '';
            
            testResults.forEach(test => {
                const className = test.passed ? 'test-pass' : 'test-fail';
                const icon = test.passed ? 'fa-check' : 'fa-times';
                html += `
                    <div class="${className} test-result">
                        <i class="fas ${icon} me-2"></i>
                        <strong>${test.name}:</strong> ${test.message}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // Test functions
        function testBootstrap() {
            if (typeof bootstrap !== 'undefined') {
                addTest('Bootstrap', true, 'Bootstrap loaded successfully');
                console.log('Bootstrap version:', bootstrap);
            } else {
                addTest('Bootstrap', false, 'Bootstrap not loaded - modals will not work');
            }
        }
        
        function testBarcodeScriptLoad() {
            console.log('Attempting to load barcode scanner script...');
            
            const script = document.createElement('script');
            script.src = './app/static/js/barcode-scanner.js';
            
            script.onload = function() {
                console.log('Barcode scanner script loaded');
                addTest('Script Load', true, 'barcode-scanner.js loaded successfully');
                testBarcodeScanner();
            };
            
            script.onerror = function() {
                console.error('Failed to load barcode scanner script');
                addTest('Script Load', false, 'Failed to load barcode-scanner.js');
            };
            
            document.head.appendChild(script);
        }
        
        function testBarcodeScanner() {
            // Wait a bit for script to initialize
            setTimeout(() => {
                if (typeof BarcodeScanner !== 'undefined') {
                    addTest('BarcodeScanner Class', true, 'BarcodeScanner class is available');
                    
                    try {
                        // Create instance without auto-initialization
                        const scanner = new BarcodeScanner();
                        addTest('Scanner Instance', true, 'BarcodeScanner can be instantiated');
                        
                        testScannerMethods(scanner);
                        testBarcodePatterns(scanner);
                        
                    } catch (error) {
                        addTest('Scanner Instance', false, `Error creating instance: ${error.message}`);
                        console.error('Scanner instantiation error:', error);
                    }
                } else {
                    addTest('BarcodeScanner Class', false, 'BarcodeScanner class not found');
                }
                
                // Test global scanner
                if (window.barcodeScanner) {
                    addTest('Global Scanner', true, 'window.barcodeScanner is available');
                } else {
                    addTest('Global Scanner', false, 'window.barcodeScanner not initialized');
                }
            }, 500);
        }
        
        function testScannerMethods(scanner) {
            const methods = ['determineBarcodeType', 'scanBarcode', 'handleBarcodeScan', 'clearBuffer'];
            
            methods.forEach(method => {
                if (typeof scanner[method] === 'function') {
                    addTest(`Method: ${method}`, true, `${method} method exists`);
                } else {
                    addTest(`Method: ${method}`, false, `${method} method missing`);
                }
            });
        }
        
        function testBarcodePatterns(scanner) {
            const testCases = [
                { barcode: 'CNT-12', expected: 'container' },
                { barcode: 'CNT-123', expected: 'container' },
                { barcode: 'BC1-1751138774-1', expected: 'sample' },
                { barcode: 'SMP-123', expected: 'sample' },
                { barcode: 'BC123-456-789', expected: 'sample' },
                { barcode: 'INVALID-123', expected: null }
            ];
            
            testCases.forEach(test => {
                try {
                    const result = scanner.determineBarcodeType(test.barcode);
                    if (result === test.expected) {
                        addTest(`Pattern: ${test.barcode}`, true, `Correctly identified as ${result || 'unknown'}`);
                    } else {
                        addTest(`Pattern: ${test.barcode}`, false, `Expected ${test.expected}, got ${result}`);
                    }
                } catch (error) {
                    addTest(`Pattern: ${test.barcode}`, false, `Error testing pattern: ${error.message}`);
                }
            });
        }
        
        // Manual test functions
        function testBarcodeScan() {
            const barcode = document.getElementById('testBarcodeInput').value.trim();
            const resultDiv = document.getElementById('scanTestResult');
            
            if (!barcode) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a barcode</div>';
                return;
            }
            
            console.log('Testing manual barcode scan:', barcode);
            resultDiv.innerHTML = '<div class="alert alert-info">Testing scan...</div>';
            
            if (window.barcodeScanner) {
                try {
                    // Try to scan without actual API call
                    const type = window.barcodeScanner.determineBarcodeType(barcode);
                    
                    if (type) {
                        resultDiv.innerHTML = `
                            <div class="alert alert-success">
                                <strong>Barcode Type:</strong> ${type}<br>
                                <strong>Pattern Match:</strong> âœ“ Valid format<br>
                                <small>Note: This tests pattern recognition only. API endpoint test below.</small>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>Unknown barcode format:</strong> ${barcode}<br>
                                <small>Check if the barcode follows expected patterns</small>
                            </div>
                        `;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${error.message}
                        </div>
                    `;
                }
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Scanner not available:</strong> window.barcodeScanner not initialized
                    </div>
                `;
            }
        }
        
        async function testAPICall() {
            const barcode = document.getElementById('testBarcodeInput').value.trim();
            const resultDiv = document.getElementById('apiTestResult');
            
            if (!barcode) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a barcode</div>';
                return;
            }
            
            console.log('Testing API call for barcode:', barcode);
            resultDiv.innerHTML = '<div class="alert alert-info">Testing API...</div>';
            
            try {
                const response = await fetch(`/api/barcode/${encodeURIComponent(barcode)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('API Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API Response data:', data);
                    
                    if (data.success) {
                        resultDiv.innerHTML = `
                            <div class="alert alert-success">
                                <strong>API Success!</strong><br>
                                <strong>Type:</strong> ${data.type}<br>
                                <strong>Data:</strong> ${JSON.stringify(data, null, 2)}
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>API returned error:</strong> ${data.error || 'Unknown error'}
                            </div>
                        `;
                    }
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>HTTP Error ${response.status}:</strong> ${errorText}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('API call failed:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>API Call Failed:</strong> ${error.message}<br>
                        <small>Make sure the Flask server is running on localhost:5000</small>
                    </div>
                `;
            }
        }
        
        // Initialize tests
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Starting diagnostic tests...');
            
            // Test Bootstrap
            testBootstrap();
            
            // Try to load barcode scanner script
            testBarcodeScriptLoad();
            
            // Set up error capturing
            window.addEventListener('error', function(e) {
                console.error('JavaScript Error:', e.message, 'at', e.filename + ':' + e.lineno);
                addTest('JavaScript Errors', false, `${e.message} at ${e.filename}:${e.lineno}`);
            });
            
            // Set up promise rejection capturing
            window.addEventListener('unhandledrejection', function(e) {
                console.error('Unhandled Promise Rejection:', e.reason);
                addTest('Promise Errors', false, `Unhandled rejection: ${e.reason}`);
            });
        });
    </script>
</body>
</html>