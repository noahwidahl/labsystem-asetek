<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Move to Test with Print Functionality Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .test-section { background: white; margin: 10px 0; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .test-button { margin: 5px; }
        .results { background: #f8f9fa; padding: 10px; border-radius: 3px; margin-top: 10px; }
        .api-response { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üß™ Move to Test with Automatic Print Test</h1>
    <p><strong>Test the complete move-to-test workflow with automatic test sample label printing</strong></p>

    <div class="test-section">
        <h3>üìä Function Availability Check</h3>
        <div id="functionStatus"></div>
    </div>

    <div class="test-section">
        <h3>üîÑ Move to Test Workflow Test</h3>
        
        <div class="row">
            <div class="col-md-6">
                <h5>Sample Data</h5>
                <div class="form-group mb-2">
                    <label>Sample ID:</label>
                    <input type="number" id="sampleId" class="form-control" value="123" min="1">
                </div>
                <div class="form-group mb-2">
                    <label>Sample Barcode:</label>
                    <input type="text" id="sampleBarcode" class="form-control" value="BC1-1751138774-1">
                </div>
                <div class="form-group mb-2">
                    <label>Sample Description:</label>
                    <input type="text" id="sampleDescription" class="form-control" value="Test Sample for Analysis">
                </div>
            </div>
            <div class="col-md-6">
                <h5>Test Data</h5>
                <div class="form-group mb-2">
                    <label>Test ID:</label>
                    <input type="number" id="testId" class="form-control" value="42" min="1">
                </div>
                <div class="form-group mb-2">
                    <label>Test Name:</label>
                    <input type="text" id="testName" class="form-control" value="Quality Check Test">
                </div>
                <div class="form-group mb-2">
                    <label>Amount:</label>
                    <input type="number" id="amount" class="form-control" value="1" min="1">
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <button class="btn btn-primary test-button" onclick="testMoveToTestWithPrint()">
                <i class="fas fa-flask me-1"></i>Test Move to Test (with Print Prompt)
            </button>
            <button class="btn btn-secondary test-button" onclick="testMoveToTestWithoutPrint()">
                <i class="fas fa-flask me-1"></i>Test Move to Test (no Print Data)
            </button>
        </div>
        
        <div class="results" id="testResults"></div>
    </div>

    <div class="test-section">
        <h3>üñ®Ô∏è Test Sample Print Functions</h3>
        <button class="btn btn-success test-button" onclick="testTestSamplePrintPrompt()">
            Test showTestSamplePrintPrompt()
        </button>
        <button class="btn btn-info test-button" onclick="testTestSamplePrintJob()">
            Test addTestSamplePrintJob()
        </button>
        <div class="results" id="printResults"></div>
    </div>

    <div class="test-section">
        <h3>üìã Print Job Queue</h3>
        <button class="btn btn-outline-secondary" onclick="showPrintJobs()">Check Print Job Queue</button>
        <button class="btn btn-outline-danger" onclick="clearPrintJobs()">Clear Queue</button>
        <div class="results" id="queueResults"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load global print functions -->
    <script src="/static/js/print-functions.js"></script>
    
    <!-- Load barcode scanner for move-to-test functionality -->
    <script src="/static/js/barcode-scanner.js"></script>
    
    <script>
        // Check if all required functions are available
        function checkFunctionAvailability() {
            const results = [];
            const functions = [
                'showTestSamplePrintPrompt',
                'addTestSamplePrintJob',
                'printTestSampleNow',
                'skipTestSamplePrint'
            ];

            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    results.push(`‚úÖ ${funcName} - Available`);
                } else {
                    results.push(`‚ùå ${funcName} - Missing`);
                }
            });

            // Check barcode scanner
            if (window.barcodeScanner) {
                results.push(`‚úÖ barcodeScanner - Available`);
            } else {
                results.push(`‚ùå barcodeScanner - Missing`);
            }

            document.getElementById('functionStatus').innerHTML = `
                <h6>Function Availability:</h6>
                <div class="alert alert-info">
                    ${results.map(result => `<div>${result}</div>`).join('')}
                </div>
            `;
        }

        // Mock API for testing
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            if (url.includes('/api/samples/') && url.includes('/move-to-test')) {
                // Mock successful move-to-test response with print data
                const mockSampleId = parseInt(url.split('/')[3]);
                const requestData = JSON.parse(options.body);
                
                return Promise.resolve({
                    json: () => Promise.resolve({
                        success: true,
                        message: 'Sample moved to test successfully',
                        added_samples: [{
                            sample_id: mockSampleId,
                            identifier: `T1234.1_1`,
                            amount: requestData.amount
                        }],
                        test_sample_data: {
                            SampleID: mockSampleId,
                            SampleIDFormatted: `SMP-${mockSampleId}`,
                            Barcode: document.getElementById('sampleBarcode').value,
                            Description: document.getElementById('sampleDescription').value,
                            PartNumber: 'PART-001',
                            Amount: requestData.amount,
                            UnitName: 'pcs',
                            TestID: requestData.test_id,
                            TestNo: 'T1234.1',
                            TestName: document.getElementById('testName').value,
                            TestBarcode: `TST${mockSampleId}${requestData.test_id}${Date.now().toString().slice(-4)}`,
                            SampleIdentifier: 'T1234.1_1',
                            show_test_print_confirmation: true
                        }
                    })
                });
            } else if (url.includes('/api/print/test-sample')) {
                // Mock print API response
                return Promise.resolve({
                    json: () => Promise.resolve({
                        status: 'success',
                        message: 'Test sample label printed successfully (mock)'
                    })
                });
            }
            
            // For other requests, use original fetch
            return originalFetch.apply(this, arguments);
        };

        // Test the complete move-to-test workflow
        async function testMoveToTestWithPrint() {
            const results = document.getElementById('testResults');
            results.innerHTML = '<div class="alert alert-info">Testing move-to-test workflow...</div>';
            
            try {
                const sampleId = document.getElementById('sampleId').value;
                const testId = document.getElementById('testId').value;
                const amount = document.getElementById('amount').value;
                
                console.log('üß™ Testing move-to-test with print prompt');
                
                const response = await fetch(`/api/samples/${sampleId}/move-to-test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        test_id: testId,
                        amount: parseInt(amount),
                        notes: 'Test from test page'
                    })
                });
                
                const result = await response.json();
                
                results.innerHTML = `
                    <div class="alert alert-success">
                        ‚úÖ API Response received successfully!
                    </div>
                    <h6>API Response:</h6>
                    <div class="api-response">
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
                
                // Check if print prompt should appear
                if (result.test_sample_data && result.test_sample_data.show_test_print_confirmation) {
                    console.log('üñ®Ô∏è Showing test sample print prompt...');
                    if (typeof showTestSamplePrintPrompt === 'function') {
                        showTestSamplePrintPrompt(result.test_sample_data);
                        results.innerHTML += `<div class="alert alert-info mt-2">üìÑ Test sample print prompt should now be visible!</div>`;
                    } else {
                        results.innerHTML += `<div class="alert alert-danger mt-2">‚ùå showTestSamplePrintPrompt function not available</div>`;
                    }
                }
                
            } catch (error) {
                results.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
            }
        }

        function testMoveToTestWithoutPrint() {
            const results = document.getElementById('testResults');
            // Temporarily override fetch to not include print data
            const tempFetch = window.fetch;
            window.fetch = function(url, options) {
                if (url.includes('/api/samples/') && url.includes('/move-to-test')) {
                    return Promise.resolve({
                        json: () => Promise.resolve({
                            success: true,
                            message: 'Sample moved to test successfully (no print data)'
                        })
                    });
                }
                return tempFetch.apply(this, arguments);
            };
            
            testMoveToTestWithPrint().then(() => {
                window.fetch = tempFetch; // Restore
                results.innerHTML += `<div class="alert alert-warning mt-2">‚ÑπÔ∏è No print prompt should appear for this test</div>`;
            });
        }

        // Test individual print functions
        function testTestSamplePrintPrompt() {
            const mockTestSampleData = {
                SampleID: 123,
                SampleIDFormatted: 'SMP-123',
                Barcode: 'BC1-1751138774-1',
                Description: 'Test Sample for Analysis',
                PartNumber: 'PART-001',
                Amount: 1,
                UnitName: 'pcs',
                TestID: 42,
                TestNo: 'T1234.1',
                TestName: 'Quality Check Test',
                TestBarcode: 'TST123424567',
                SampleIdentifier: 'T1234.1_1'
            };
            
            if (typeof showTestSamplePrintPrompt === 'function') {
                showTestSamplePrintPrompt(mockTestSampleData);
                document.getElementById('printResults').innerHTML = `<div class="alert alert-success">‚úÖ Test sample print prompt shown with mock data</div>`;
            } else {
                document.getElementById('printResults').innerHTML = `<div class="alert alert-danger">‚ùå showTestSamplePrintPrompt function not available</div>`;
            }
        }

        function testTestSamplePrintJob() {
            const mockTestSampleData = {
                SampleID: 456,
                SampleIDFormatted: 'SMP-456',
                TestBarcode: 'TST456789123',
                Description: 'Another Test Sample',
                TestName: 'Another Test',
                TestID: 789,
                SampleIdentifier: 'T789.1_1'
            };
            
            if (typeof addTestSamplePrintJob === 'function') {
                addTestSamplePrintJob(mockTestSampleData, 'queued');
                document.getElementById('printResults').innerHTML = `<div class="alert alert-success">‚úÖ Test sample print job added to queue</div>`;
                showPrintJobs();
            } else {
                document.getElementById('printResults').innerHTML = `<div class="alert alert-danger">‚ùå addTestSamplePrintJob function not available</div>`;
            }
        }

        function showPrintJobs() {
            const printJobs = JSON.parse(localStorage.getItem('printJobs') || '[]');
            const testSampleJobs = printJobs.filter(job => job.type === 'test_sample');
            
            document.getElementById('queueResults').innerHTML = `
                <h6>Print Job Queue Status:</h6>
                <div class="alert alert-info">
                    <strong>Total Jobs:</strong> ${printJobs.length}<br>
                    <strong>Test Sample Jobs:</strong> ${testSampleJobs.length}<br>
                    <strong>Latest Jobs:</strong>
                    <div class="api-response">
                        <pre>${JSON.stringify(printJobs.slice(0, 5), null, 2)}</pre>
                    </div>
                </div>
            `;
        }

        function clearPrintJobs() {
            localStorage.removeItem('printJobs');
            showPrintJobs();
            console.log('üóëÔ∏è Print queue cleared');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Move to test print functionality test page loaded');
            checkFunctionAvailability();
            showPrintJobs();
        });
    </script>
</body>
</html>