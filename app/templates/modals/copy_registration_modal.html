<div class="modal" id="copyRegistrationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="fas fa-copy me-2"></i>Use previous registration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>About copy registration:</strong> 
                    <p class="mb-0">Select a previous registration to reuse information such as part number, description, and unit. You still need to specify quantity and location.</p>
                </div>
                
                <div class="form-group mb-4">
                    <label class="form-label fw-bold">Search and select existing registration</label>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                        <input type="text" class="form-control" id="sampleSearchInput" placeholder="Search by description, part number or ID..." autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" id="sampleSearchButton">
                            Search
                        </button>
                    </div>
                    <select class="form-select form-select-lg" id="existingRegistrations" size="8" style="height: auto;">
                        <!-- Populated dynamically -->
                        <option disabled selected>Loading samples...</option>
                    </select>
                    <small class="text-muted">Type in the search box to filter the list of samples. Results will show as you type.</small>
                </div>
                
                <div id="samplePreviewArea" class="d-none bg-light p-3 rounded mt-4">
                    <h6 class="border-bottom pb-2 mb-3">Sample Preview</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ID:</strong> <span id="previewId">-</span></p>
                            <p><strong>Part Number:</strong> <span id="previewPartNumber">-</span></p>
                            <p><strong>Description:</strong> <span id="previewDescription">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Unit:</strong> <span id="previewUnit">-</span></p>
                            <p><strong>Registered:</strong> <span id="previewDate">-</span></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="copyRegistration()">
                    <i class="fas fa-clone me-1"></i> Use selected sample
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Update preview when selection changes
    document.addEventListener('DOMContentLoaded', function() {
        const existingRegistrations = document.getElementById('existingRegistrations');
        const searchInput = document.getElementById('sampleSearchInput');
        const searchButton = document.getElementById('sampleSearchButton');
        
        // Store all samples for filtering
        let allSamples = [];
        
        // Function to update the preview area
        function updatePreview() {
            const selectedOption = existingRegistrations.options[existingRegistrations.selectedIndex];
            const previewArea = document.getElementById('samplePreviewArea');
            
            if (selectedOption && selectedOption.dataset.sample) {
                try {
                    const sampleData = JSON.parse(selectedOption.dataset.sample);
                    
                    // Update preview fields
                    document.getElementById('previewId').textContent = sampleData.SampleIDFormatted || '-';
                    document.getElementById('previewPartNumber').textContent = sampleData.PartNumber || '-';
                    document.getElementById('previewDescription').textContent = sampleData.Description || '-';
                    document.getElementById('previewUnit').textContent = sampleData.UnitName || '-';
                    document.getElementById('previewDate').textContent = sampleData.RegisteredDate || '-';
                    
                    // Show preview area
                    previewArea.classList.remove('d-none');
                } catch (error) {
                    console.error('Error updating sample preview:', error);
                    previewArea.classList.add('d-none');
                }
            } else {
                // Hide preview area
                previewArea.classList.add('d-none');
            }
        }
        
        // Function to filter samples based on search term
        function filterSamples(searchTerm) {
            if (!allSamples.length) return;
            
            // Clear dropdown
            existingRegistrations.innerHTML = '';
            
            // If no search term, show all samples
            if (!searchTerm) {
                populateDropdown(allSamples);
                return;
            }
            
            // Convert to lowercase for case-insensitive search
            searchTerm = searchTerm.toLowerCase().trim();
            
            // Split search term into words for better matching
            const searchWords = searchTerm.split(/\s+/).filter(word => word.length > 0);
            
            // Score and filter samples based on search term
            const scoredSamples = allSamples.map(sample => {
                const description = (sample.Description || '').toLowerCase();
                const partNumber = (sample.PartNumber || '').toLowerCase();
                const sampleId = (sample.SampleIDFormatted || '').toLowerCase();
                
                // Calculate match score - higher is better
                let score = 0;
                
                // Exact matches get highest score
                if (description === searchTerm) score += 100;
                if (partNumber === searchTerm) score += 100;
                if (sampleId === searchTerm) score += 100;
                
                // Starts with matches get high score
                if (description.startsWith(searchTerm)) score += 50;
                if (partNumber.startsWith(searchTerm)) score += 50;
                if (sampleId.startsWith(searchTerm)) score += 50;
                
                // Contains matches get medium score
                if (description.includes(searchTerm)) score += 25;
                if (partNumber.includes(searchTerm)) score += 25;
                if (sampleId.includes(searchTerm)) score += 25;
                
                // Word matches get scores too
                for (const word of searchWords) {
                    if (word.length < 2) continue; // Skip very short words
                    
                    if (description.includes(word)) score += 10;
                    if (partNumber.includes(word)) score += 10;
                    if (sampleId.includes(word)) score += 10;
                    
                    // Partial word matches get lower score
                    const wordPattern = new RegExp(word.split('').join('.*'), 'i');
                    if (wordPattern.test(description)) score += 5;
                    if (wordPattern.test(partNumber)) score += 5;
                    if (wordPattern.test(sampleId)) score += 5;
                }
                
                return { sample, score };
            }).filter(item => item.score > 0)
              .sort((a, b) => b.score - a.score) // Sort by score, highest first
              .map(item => item.sample); // Just return the sample objects
            
            // Populate dropdown with filtered samples
            populateDropdown(scoredSamples);
            
            // Update message if no results
            if (scoredSamples.length === 0) {
                const noResultsOption = document.createElement('option');
                noResultsOption.textContent = `No results found for "${searchTerm}"`;
                noResultsOption.disabled = true;
                existingRegistrations.appendChild(noResultsOption);
            }
            
            // Add status message showing result count
            if (scoredSamples.length > 0) {
                const countMessage = document.getElementById('sampleSearchCount');
                if (countMessage) {
                    countMessage.textContent = `Found ${scoredSamples.length} matches`;
                    countMessage.classList.remove('d-none');
                } else {
                    const messageElement = document.createElement('div');
                    messageElement.id = 'sampleSearchCount';
                    messageElement.className = 'text-muted small mt-1';
                    messageElement.textContent = `Found ${scoredSamples.length} matches`;
                    const parentElement = existingRegistrations.parentElement;
                    if (parentElement) {
                        parentElement.insertBefore(messageElement, existingRegistrations.nextSibling);
                    }
                }
            } else {
                const countMessage = document.getElementById('sampleSearchCount');
                if (countMessage) {
                    countMessage.classList.add('d-none');
                }
            }
            
            // Highlight matching text in dropdown options (visual feedback)
            if (searchTerm && scoredSamples.length > 0) {
                for (let i = 0; i < existingRegistrations.options.length; i++) {
                    const option = existingRegistrations.options[i];
                    const text = option.textContent;
                    
                    // Skip if it's a disabled option
                    if (option.disabled) continue;
                    
                    // Add title with match info
                    let matchInfo = [];
                    const sample = scoredSamples[i];
                    
                    if (sample.Description && sample.Description.toLowerCase().includes(searchTerm)) {
                        matchInfo.push(`Match in description: "${sample.Description}"`);
                    }
                    
                    if (sample.PartNumber && sample.PartNumber.toLowerCase().includes(searchTerm)) {
                        matchInfo.push(`Match in part number: "${sample.PartNumber}"`);
                    }
                    
                    if (sample.SampleIDFormatted && sample.SampleIDFormatted.toLowerCase().includes(searchTerm)) {
                        matchInfo.push(`Match in sample ID: "${sample.SampleIDFormatted}"`);
                    }
                    
                    // Set title with match info
                    if (matchInfo.length > 0) {
                        option.title = matchInfo.join('\n');
                    }
                }
            }
        }
        }
        
        // Function to populate dropdown with samples
        function populateDropdown(samples) {
            // Clear existing options
            existingRegistrations.innerHTML = '';
            
            // Add samples to dropdown
            samples.forEach(sample => {
                const option = document.createElement('option');
                option.value = sample.SampleID;
                option.textContent = `${sample.SampleIDFormatted}: ${sample.Description || ''} ${sample.PartNumber ? '(' + sample.PartNumber + ')' : ''}`;
                option.dataset.sample = JSON.stringify(sample);
                existingRegistrations.appendChild(option);
            });
            
            // Update preview if samples exist
            if (samples.length > 0) {
                existingRegistrations.selectedIndex = 0;
                updatePreview();
            }
        }
        
        // Set up event listeners
        if (existingRegistrations) {
            existingRegistrations.addEventListener('change', updatePreview);
        }
        
        if (searchInput) {
            // Search on input with debounce
            let debounceTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimeout);
                
                // Show/hide clear button based on input
                const clearButton = document.getElementById('sampleSearchClear');
                if (clearButton) {
                    clearButton.style.display = this.value ? 'block' : 'none';
                }
                
                debounceTimeout = setTimeout(() => {
                    filterSamples(this.value.trim());
                }, 300);
            });
            
            // Search on Enter key
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    filterSamples(this.value.trim());
                }
            });
            
            // Add clear button to search input
            const inputGroup = searchInput.parentElement;
            if (inputGroup) {
                const clearButton = document.createElement('button');
                clearButton.type = 'button';
                clearButton.className = 'btn btn-outline-secondary position-absolute end-0 top-0 bottom-0 d-none';
                clearButton.id = 'sampleSearchClear';
                clearButton.innerHTML = '<i class="fas fa-times"></i>';
                clearButton.style.zIndex = '5';
                clearButton.style.border = 'none';
                clearButton.style.display = 'none';
                clearButton.style.borderRadius = '0 4px 4px 0';
                clearButton.title = 'Clear search';
                
                // Position the clear button
                inputGroup.style.position = 'relative';
                
                // Handle clear button click
                clearButton.addEventListener('click', function() {
                    searchInput.value = '';
                    searchInput.focus();
                    this.style.display = 'none';
                    filterSamples(''); // Show all samples
                });
                
                // Insert after search input but before search button
                inputGroup.insertBefore(clearButton, searchButton);
            }
        }
        
        if (searchButton) {
            searchButton.addEventListener('click', function() {
                filterSamples(searchInput.value.trim());
            });
        }
        
        // Override the loadPreviousRegistrations function to store all samples
        const originalLoadFunction = window.loadPreviousRegistrations;
        window.loadPreviousRegistrations = function() {
            const dropdown = document.getElementById('existingRegistrations');
            
            // Clear existing options
            while (dropdown.firstChild) {
                dropdown.removeChild(dropdown.firstChild);
            }
            
            // Add loading option
            const loadingOption = document.createElement('option');
            loadingOption.textContent = 'Loading samples...';
            loadingOption.disabled = true;
            dropdown.appendChild(loadingOption);
            
            // Clear search input
            if (searchInput) searchInput.value = '';
            
            // Fetch recent samples
            fetch('/api/samples/recent')
            .then(response => response.json())
            .then(data => {
                // Store all samples for filtering
                allSamples = data.success && data.samples ? data.samples : [];
                
                // Clear dropdown
                dropdown.innerHTML = '';
                
                if (allSamples.length > 0) {
                    // Add samples to dropdown
                    populateDropdown(allSamples);
                } else {
                    // No samples found
                    const noSamplesOption = document.createElement('option');
                    noSamplesOption.textContent = 'No previous samples found';
                    noSamplesOption.disabled = true;
                    dropdown.appendChild(noSamplesOption);
                }
                
                // Focus search input
                if (searchInput) searchInput.focus();
            })
            .catch(error => {
                dropdown.innerHTML = '';
                const errorOption = document.createElement('option');
                errorOption.textContent = 'Error loading samples';
                errorOption.disabled = true;
                dropdown.appendChild(errorOption);
                console.error('Error loading previous registrations:', error);
            });
        };
    });
</script>