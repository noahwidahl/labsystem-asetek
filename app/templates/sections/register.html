{% extends "base.html" %}

{% block title %}Registrer Prøver - Laboratorie Prøvesystem{% endblock %}

{% block content %}
<section id="register" class="content-section">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h2>Registrer Prøver</h2>
                <hr>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="#step1" data-bs-toggle="tab">Modtagelse</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#step2" data-bs-toggle="tab">Prøve Information</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#step3" data-bs-toggle="tab">Identifikation</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#step4" data-bs-toggle="tab">Placering</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <!-- Step 1: Modtagelse -->
                    <div class="tab-pane fade show active" id="step1">
                        <h4>Modtagelsesoplysninger</h4>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Leverandør</label>
                                    <select class="form-control" name="supplier" id="supplierSelect">
                                        <option value="">Ingen leverandør (intern afsender)</option>
                                        {% for supplier in suppliers %}
                                        <option value="{{ supplier.SupplierID }}">{{ supplier.SupplierName }}</option>
                                        {% endfor %}
                                        <option value="new">+ Opret ny leverandør</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Tracking-nummer</label>
                                    <input type="text" class="form-control" name="trackingNumber" placeholder="F.eks. DHL tracking nummer">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Registreret af</label>
                            <input type="text" class="form-control" name="custodian" readonly value="{{ current_user.Name }}">
                            <input type="hidden" name="custodianId" value="{{ current_user.UserID }}">
                        </div>
                    </div>

                    <!-- Step 2: Prøve Information -->
                    <div class="tab-pane fade" id="step2">
                        <h4>Prøve Information</h4>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Beskrivelse</label>
                                    <input type="text" class="form-control" name="description" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Antal</label>
                                    <input type="number" class="form-control" name="totalAmount" required min="1">
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Enhed</label>
                                    <select class="form-control" name="unit" required>
                                        <option value="">Vælg enhed</option>
                                        {% for unit in units %}
                                        <option value="{{ unit.UnitID }}">{{ unit.UnitName }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ansvarlig</label>
                                    <select class="form-control" name="owner" required>
                                        <option value="{{ current_user.UserID }}" selected>{{ current_user.Name }} (dig)</option>
                                        {% for user in users %}
                                        {% if user.UserID != current_user.UserID %}
                                        <option value="{{ user.UserID }}">{{ user.Name }}</option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="hasSerialNumbers" name="hasSerialNumbers">
                            <label class="form-check-label" for="hasSerialNumbers">
                                Prøverne har individuelle serienumre
                            </label>
                        </div>
                    </div>

                    <!-- Step 3: Identifikation -->
                    <div class="tab-pane fade" id="step3">
                        <h4>Prøve Identifikation</h4>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Scan eller indtast serienumre for hver prøve her.
                        </div>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="barcodeInput" placeholder="Scan eller indtast serienummer">
                            <button class="btn btn-primary" type="button" id="addBarcode">Tilføj</button>
                        </div>
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Scannede prøver: <span id="scannedCount">0</span></span>
                                <button class="btn btn-sm btn-outline-danger" id="clearScanned">Ryd alle</button>
                            </div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush" id="scannedList">
                                    <li class="list-group-item text-center text-muted">Ingen prøver scannet endnu</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Placering -->
                    <div class="tab-pane fade" id="step4">
                        <h4>Placering</h4>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Vælg lagerplads</label>
                                    <select class="form-control" name="storageLocation" required>
                                        <option value="">Vælg plads</option>
                                        {% for location in locations %}
                                        <option value="{{ location.LocationID }}">{{ location.LocationName }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Lageroversigt</h5>
                            </div>
                            <div class="card-body">
                                <div class="storage-grid">
                                    <!-- Dynamisk udfyldt via JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-3 border-top">
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-secondary" id="prevBtn">Tilbage</button>
                        <button class="btn btn-primary" id="nextBtn">Næste</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Simpel step-navigation til test
    const tabs = document.querySelectorAll('.nav-link');
    const tabPanes = document.querySelectorAll('.tab-pane');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    let currentStep = 0;
    
    // Initial state
    prevBtn.style.visibility = 'hidden';
    
    function showStep(step) {
        // Hide all tabs and panes
        tabs.forEach(tab => tab.classList.remove('active'));
        tabPanes.forEach(pane => {
            pane.classList.remove('show', 'active');
        });
        
        // Show current tab and pane
        tabs[step].classList.add('active');
        tabPanes[step].classList.add('show', 'active');
        
        // Update buttons
        prevBtn.style.visibility = step === 0 ? 'hidden' : 'visible';
        nextBtn.textContent = step === tabs.length - 1 ? 'Gem' : 'Næste';
    }
    
    prevBtn.addEventListener('click', () => {
        if (currentStep > 0) {
            currentStep--;
            showStep(currentStep);
        }
    });
    
    nextBtn.addEventListener('click', () => {
        if (currentStep < tabs.length - 1) {
            currentStep++;
            showStep(currentStep);
        } else {
            // Submit form logic would go here
            alert('Form would be submitted here');
        }
    });
    
    // Scanner simulation
    const barcodeInput = document.getElementById('barcodeInput');
    const addBtn = document.getElementById('addBarcode');
    const clearBtn = document.getElementById('clearScanned');
    const scannedList = document.getElementById('scannedList');
    const scannedCount = document.getElementById('scannedCount');
    let scannedItems = [];
    
    function updateScannedUI() {
        scannedCount.textContent = scannedItems.length;
        
        if (scannedItems.length === 0) {
            scannedList.innerHTML = '<li class="list-group-item text-center text-muted">Ingen prøver scannet endnu</li>';
            return;
        }
        
        scannedList.innerHTML = '';
        scannedItems.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <span>${index + 1}. ${item}</span>
                <button class="btn btn-sm btn-outline-danger remove-item" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            scannedList.appendChild(li);
        });
        
        // Attach remove handlers
        document.querySelectorAll('.remove-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                scannedItems.splice(index, 1);
                updateScannedUI();
            });
        });
    }
    
    addBtn.addEventListener('click', () => {
        const barcode = barcodeInput.value.trim();
        if (barcode) {
            if (!scannedItems.includes(barcode)) {
                scannedItems.push(barcode);
                updateScannedUI();
                barcodeInput.value = '';
            } else {
                alert('Denne stregkode er allerede scannet');
            }
        }
        barcodeInput.focus();
    });
    
    barcodeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addBtn.click();
        }
    });
    
    clearBtn.addEventListener('click', () => {
        if (confirm('Er du sikker på, at du vil fjerne alle scannede prøver?')) {
            scannedItems = [];
            updateScannedUI();
        }
    });
});
</script>
{% endblock %}