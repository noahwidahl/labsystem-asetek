{% extends "base.html" %}

{% block title %}Register Samples - Laboratory Sample System{% endblock %}

{% block content %}
<!-- Custom styles for supplier search -->
<style>
    .supplier-search-results {
        position: absolute;
        z-index: 1000;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 4px;
        max-height: 250px;
        overflow-y: auto;
        width: 100%;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .supplier-search-item {
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .supplier-search-item:hover {
        background-color: #f8f9fa;
    }
    
    .supplier-search-item.active {
        background-color: #e9ecef;
    }
    
    .supplier-search-empty {
        padding: 8px 12px;
        color: #6c757d;
        font-style: italic;
    }
    
    .selected-supplier {
        margin-top: 5px;
    }
    
    .selected-supplier .badge {
        font-size: 14px;
        padding: 5px 8px;
    }
</style>
<!-- Include modals -->
{% include 'modals/new_supplier_modal.html' %}
{% include 'modals/copy_registration_modal.html' %}
<section id="register" class="content-section">
    <div class="registration-container">
        <div class="registration-steps">
            <div class="steps-container">
                <div class="step active">
                    <span>Reception</span>
                </div>
                <div class="step">
                    <span>Sample Information</span>
                </div>
                <div class="step">
                    <span>Identification</span>
                </div>
                <div class="step">
                    <span>Location</span>
                </div>
            </div>
            <div class="progress mt-3">
                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
        </div>

        <div class="registration-form">
            <!-- Step 1: Reception Details -->
            <div class="form-step active" id="step1">
                <h3>Reception Details</h3>
                <div class="form-group">
                    <label>Supplier</label>
                    <div class="mb-2">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                            </div>
                            <input type="text" class="form-control" id="supplierSearchInput" placeholder="Search for supplier..." autocomplete="off">
                            <input type="hidden" name="supplier" id="supplierIdInput" value="">
                        </div>
                        <div id="supplierResults" class="supplier-search-results mt-1 d-none">
                            <!-- Search results will appear here -->
                        </div>
                        <div id="selectedSupplierDisplay" class="selected-supplier mt-2 d-none">
                            <span class="badge bg-primary">
                                <span id="selectedSupplierName">No supplier selected</span>
                                <button type="button" class="btn btn-sm text-white" id="clearSupplierBtn" style="border: none; background: none; padding: 0 4px;">Ã—</button>
                            </span>
                        </div>
                    </div>
                    <div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#newSupplierModal">
                            <i class="fas fa-plus me-1"></i> Create new supplier
                        </button>
                    </div>
                    <small class="text-muted">Optional - select only if sample comes from external supplier</small>
                </div>
                <div class="form-group">
                    <label>Tracking number</label>
                    <input type="text" class="form-control" name="trackingNumber" placeholder="E.g. DHL tracking number">
                </div>
                <div class="form-group">
                    <label>Registered by</label>
                    <input type="text" class="form-control" name="custodian" readonly value="{{ current_user.Name }}">
                    <input type="hidden" name="custodian" value="{{ current_user.UserID }}">
                    <small class="text-muted">Person registering this sample in the system</small>
                </div>
            </div>

            <!-- Step 2: Sample Information -->
            <div class="form-step" id="step2">
                <div class="copy-buttons mb-3">
                    <button type="button" class="btn-copy btn btn-outline-primary" id="copyLastButton">
                        <i class="fas fa-clone me-1"></i>
                        Use last registered sample
                    </button>
                    <button class="btn-copy btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#copyRegistrationModal">
                        <i class="fas fa-copy me-1"></i>
                        Use any registered sample
                    </button>
                </div>
                
                <!-- Alert that appears when data is copied -->
                <div id="dataCopiedAlert" class="alert alert-success mb-3 d-none">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="dataCopiedMessage">Sample data copied successfully!</span>
                    <button type="button" class="btn-close float-end" onclick="document.getElementById('dataCopiedAlert').classList.add('d-none')"></button>
                </div>
                <h3>Sample Information</h3>
                
                <!-- Basic Sample Info - Always visible -->
                <div class="form-group">
                    <label>Part number</label>
                    <input type="text" class="form-control" name="partNumber">
                </div>
                <div class="form-group">
                    <label>Sample name</label>
                    <input type="text" class="form-control" name="description" required>
                </div>
                <div class="form-group">
                    <label>Expire Date</label>
                    <input type="date" class="form-control" name="expireDate" id="expireDate">
                    <small class="text-muted">Leave empty to use default (2 months from today)</small>
                </div>

                <!-- Sample Type Selection Card -->
                <div class="card mb-4 mt-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Sample Type</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-4">
                            <label class="fw-bold mb-2">Choose Sample Type:</label>
                            <div class="ms-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="sampleTypeOption" id="singleSampleOption" value="single" checked>
                                    <label class="form-check-label" for="singleSampleOption">
                                        <strong>Standard Sample</strong>
                                    </label>
                                    <small class="text-muted d-block ms-4">A single item, component, or countable sample</small>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="sampleTypeOption" id="bulkSampleOption" value="bulk">
                                    <label class="form-check-label" for="bulkSampleOption">
                                        <strong>Bulk Material</strong>
                                    </label>
                                    <small class="text-muted d-block ms-4">Material measured in length, weight, or volume</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Storage Options Card -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Storage Option</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="fw-bold mb-2">Choose Storage Option:</label>
                            <div class="ms-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="storageOption" id="directStorageOption" value="direct" checked>
                                    <label class="form-check-label" for="directStorageOption">
                                        <strong>Direct Storage</strong>
                                    </label>
                                    <small class="text-muted d-block ms-4">Store samples directly on shelf without container</small>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="storageOption" id="containerStorageOption" value="container">
                                    <label class="form-check-label" for="containerStorageOption">
                                        <strong>Store in Container</strong>
                                    </label>
                                    <small class="text-muted d-block ms-4">Place samples in physical containers</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Container Options - Shows only for Container Storage -->
                <div id="containerOptions" class="d-none card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Container Options</h5>
                    </div>
                    <div class="card-body">
                        <!-- For Single Sample or Bulk Material -->
                        <div id="singleContainerOptions">
                            <div class="form-group mb-3">
                                <div class="d-flex align-items-center mb-2">
                                    <input type="radio" name="containerOption" id="newContainerOption" value="new" checked>
                                    <label for="newContainerOption" class="ms-2 mb-0">Create new container</label>
                                </div>
                                <div class="d-flex align-items-center">
                                    <input type="radio" name="containerOption" id="existingContainerOption" value="existing">
                                    <label for="existingContainerOption" class="ms-2 mb-0">Select existing container</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- For Multiple Samples -->
                        <div id="multipleContainerOptions" class="d-none">
                            <div class="form-group mb-3">
                                <div class="d-flex align-items-center mb-2">
                                    <input type="radio" name="multiContainerOption" id="oneContainerPerPackage" value="multiple" checked onchange="if(typeof updateContainerLocationVisibility === 'function') updateContainerLocationVisibility()">
                                    <label for="oneContainerPerPackage" class="ms-2 mb-0">One container per package</label>
                                </div>
                                <div class="d-flex align-items-center">
                                    <input type="radio" name="multiContainerOption" id="oneContainerForAll" value="single" onchange="if(typeof updateContainerLocationVisibility === 'function') updateContainerLocationVisibility()">
                                    <label for="oneContainerForAll" class="ms-2 mb-0">One container for all samples</label>
                                </div>
                                <div class="alert alert-info mt-2" id="multiLocationInfo" style="display: none;">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Select one location for each package in the grid during Step 4.</span>
                                </div>
                                <!-- Error message area for container options -->
                                <div class="alert alert-danger mt-2 d-none" id="containerOptionsError">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span id="containerOptionsErrorMessage"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Container Selection for Existing Container -->
                        <div id="existingContainerSelectArea" class="d-none mt-3">
                            <div class="form-group">
                                <label>Select an existing container</label>
                                <select class="form-control" id="existingContainerSelect" name="existingContainer">
                                    <option value="">Select container...</option>
                                    <!-- Populated dynamically with containers -->
                                </select>
                                <small class="text-muted">Select a container created via Container Administration</small>
                            </div>
                        </div>
                        
                        <!-- Container Details for New Container -->
                        <div id="containerDetailsSection" class="mt-3">
                            <div class="form-group mb-3">
                                <label>Container description <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="containerDescription" name="containerDescription" placeholder="E.g. 'Red plastic box'" required>
                                <small class="text-muted">Provide a descriptive name for the container (required)</small>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="containerIsMixed" name="containerIsMixed">
                                <label class="form-check-label" for="containerIsMixed">
                                    Can contain mixed sample types
                                </label>
                            </div>
                            
                            <div class="form-group mb-3" id="containerLocationSelectSection">
                                <label>Storage Location <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="containerLocation" placeholder="Ex. 1.1.1" required>
                                <small class="text-muted">Enter location in format "x.x.x" (e.g. 1.1.1). For multiple containers, you'll select locations in the grid later.</small>
                                <div id="locationFormatError" class="invalid-feedback">
                                    Please enter a valid location in format "x.x.x" (e.g. 1.1.1)
                                </div>
                            </div>
                            
                            <!-- Container Type Selection as Radio Buttons -->
                            <div class="form-group mb-3">
                                <label class="d-block mb-2">Container Type Options:</label>
                                <div class="mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="containerTypeOption" id="useExistingTypeOption" value="existing" checked>
                                        <label class="form-check-label" for="useExistingTypeOption">
                                            Select existing container type
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="containerTypeOption" id="createNewTypeOption" value="new">
                                        <label class="form-check-label" for="createNewTypeOption">
                                            Create new container type
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Existing Container Type Selection (shown by default) -->
                            <div id="existingContainerTypeSection">
                                <div class="form-group mb-3">
                                    <label>Container type <span class="text-danger">*</span></label>
                                    <select class="form-control" id="containerType" required>
                                        <option value="">Select type</option>
                                        {% for type in container_types %}
                                        <option value="{{ type.ContainerTypeID }}" data-capacity="{{ type.DefaultCapacity }}">{{ type.TypeName }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label>Capacity</label>
                                    <input type="number" class="form-control" id="containerCapacity" min="1" placeholder="Will use type's default capacity if not specified">
                                    <small class="text-muted">Maximum number of units this container can hold</small>
                                </div>
                            </div>
                            
                            <!-- New Container Type Section (hidden by default) -->
                            <div id="newContainerTypeSection" class="d-none border p-3 mb-3 rounded bg-light">
                                <h6 class="mb-3">New Container Type</h6>
                                <div class="form-group mb-3">
                                    <label>Type Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newContainerTypeName" placeholder="E.g. 'Box'">
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label>Default Capacity <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="newContainerTypeCapacity" min="1" placeholder="Default capacity">
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label>Description</label>
                                    <textarea class="form-control" id="newContainerTypeDescription" rows="2" placeholder="Description of this type"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Serial Numbers Option -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Identification</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hasSerialNumbers" name="hasSerialNumbers">
                            <label class="form-check-label" for="hasSerialNumbers">
                                <strong>Samples have individual serial numbers</strong>
                            </label>
                            <small class="text-muted d-block ms-4">Select this if each sample has a unique serial number or barcode</small>
                        </div>
                    </div>
                </div>

                <!-- Common Fields for All Sample Types -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Total Amount</label>
                            <input type="number" class="form-control" name="totalAmount" required min="1" value="1">
                            <small class="text-muted" id="totalAmountHelper">Total number of units received</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Unit</label>
                            <select class="form-control" name="unit" required>
                                <option value="">Select unit</option>
                                {% for unit in units %}
                                <option value="{{ unit.UnitID }}">{{ unit.UnitName }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted unit-helper">Units depend on sample type (pcs for items, other units for bulk)</small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Responsible for sample</label>
                    <select class="form-control" name="owner" required>
                        <option value="{{ current_user.UserID }}" selected>{{ current_user.Name }} (you)</option>
                        {% for user in users %}
                        {% if user.UserID != current_user.UserID %}
                        <option value="{{ user.UserID }}">{{ user.Name }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                    <small class="text-muted">Select the person responsible for this sample</small>
                </div>
                
                <div class="form-group">
                    <label>Expiry date</label>
                    <input type="date" class="form-control" name="expiryDate">
                    <small class="text-muted">Default: 2 months from today</small>
                </div>
                
                <div class="form-group">
                    <label>Other</label>
                    <textarea class="form-control" name="other" rows="3" placeholder="Enter any remarks or other details"></textarea>
                </div>
            </div>

            <!-- Step 3: Identification -->
            <div class="form-step" id="step3">
                <h3>Sample Identification</h3>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    Here you can scan or enter serial numbers for your samples. Each unique sample must have its own serial number.
                </div>
                
                <div class="scanner-section">
                    <div class="scanner-header">
                        <div class="counter">Scanned samples: <span id="scannedCount">0</span> of <span id="totalCount">0</span></div>
                        <div class="btn-group">
                            <button class="btn btn-outline-primary" id="scanButton">
                                <i class="fas fa-barcode"></i> Start Scanning
                            </button>
                            <button class="btn btn-outline-secondary" id="bulkEntryButton">
                                <i class="fas fa-list"></i> Bulk Entry
                            </button>
                        </div>
                    </div>
                    
                    <div class="scan-input-group">
                        <input type="text" class="form-control" id="barcodeInput" placeholder="Scan or enter serial number" autofocus>
                        <button class="btn btn-secondary" id="addManualBtn">Add</button>
                    </div>
                    
                    <!-- New bulk entry section -->
                    <div class="bulk-entry d-none mt-3 mb-3">
                        <div class="form-group">
                            <label>Enter multiple serial numbers (one per line)</label>
                            <textarea class="form-control" id="bulkBarcodes" rows="5" placeholder="Enter serial numbers here, one per line"></textarea>
                        </div>
                        <button class="btn btn-primary mt-2" id="addBulkBtn">Add all</button>
                    </div>
                    
                    <!-- New organized list of scanned items -->
                    <div class="scanned-items-header mt-4 d-flex justify-content-between">
                        <h5>Scanned samples</h5>
                        <button class="btn btn-sm btn-outline-danger" id="clearAllScannedBtn">Clear all</button>
                    </div>
                    
                    <div class="scanned-items mt-2">
                        <!-- Scanned items displayed here via JavaScript -->
                        <div class="empty-scanned-message text-center p-3 text-muted">
                            No samples scanned yet. Use the scanner or enter serial numbers manually above.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Location -->
            <div class="form-step" id="step4">
                <h3>Select Location</h3>
                <div class="storage-selector">
                    <!-- Info box with dynamic content based on selection -->
                    <div class="alert alert-info mb-3" id="storageInstructions">
                        <i class="fas fa-info-circle"></i>
                        <span id="storageInstructionsText">
                            Select storage location by clicking on an available space in the grid below.
                        </span>
                    </div>

                    <!-- Location summary that changes based on selections -->
                    <div id="locationSummary" class="mb-3 p-3 bg-light rounded d-none">
                        <h5>Storage Summary</h5>
                        <div id="locationSummaryContent">
                            <!-- Filled dynamically based on selections -->
                        </div>
                    </div>

                    <div class="storage-grid">
                        <!-- Dynamically generated grid of available spaces via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="form-navigation mt-4">
                <div class="form-nav-buttons">
                    <button id="prevButton" class="btn btn-secondary" style="display: none;">Back</button>
                    <button id="nextButton" class="btn btn-primary">Next</button>
                </div>
                <div class="progress mt-3">
                    <div class="progress-bar" role="progressbar" style="width: 25%"></div>
                </div>
            </div>

            <!-- Preview/Summary Panel - Shows before final submission -->
            <div id="registrationSummary" class="d-none mt-4 p-3 bg-light rounded">
                <h4>Registration Summary</h4>
                <div id="summaryContent">
                    <!-- Filled dynamically before submission -->
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<!-- Global data -->
<script>
window.suppliers = {{ suppliers|tojson }};
</script>

<!-- Load critical dependencies first -->
<script src="{{ url_for('static', filename='js/container.js') }}"></script>

<!-- Supplier and Copy Registration functions -->
<script>
    // Function to create a new supplier
    function createNewSupplier() {
        const supplierName = document.getElementById('newSupplierName').value.trim();
        const supplierNotes = document.getElementById('newSupplierNotes')?.value.trim() || '';
        
        if (!supplierName) {
            // Show validation error
            const nameInput = document.getElementById('newSupplierName');
            nameInput.classList.add('is-invalid');
            nameInput.focus();
            return;
        }
        
        // Show a loading indicator
        const saveButton = document.getElementById('createSupplierBtn');
        const originalText = saveButton.innerHTML;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Creating...';
        saveButton.disabled = true;
        
        // Send API request to create new supplier
        fetch('/api/suppliers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                name: supplierName,
                notes: supplierNotes
            })
        })
        .then(response => response.json())
        .then(data => {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
            
            if (data.success) {
                // Add the new supplier to the dropdown
                const supplierSelect = document.getElementById('supplierSelect');
                const newOption = document.createElement('option');
                newOption.value = data.supplier_id;
                newOption.textContent = supplierName;
                
                // Insert before the "Create new supplier" option (which should be the last one)
                supplierSelect.insertBefore(newOption, supplierSelect.lastChild);
                
                // Select the newly created supplier
                supplierSelect.value = data.supplier_id;
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('newSupplierModal'));
                modal.hide();
                
                // Show success message
                alert('Supplier created successfully');
            } else {
                alert('Error creating supplier: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
            alert('Error creating supplier: ' + error.message);
        });
    }
    
    // Function to fetch and populate recent registrations for the copy modal
    function loadPreviousRegistrations() {
        const dropdown = document.getElementById('existingRegistrations');
        
        // Clear existing options
        while (dropdown.firstChild) {
            dropdown.removeChild(dropdown.firstChild);
        }
        
        // Add loading option
        const loadingOption = document.createElement('option');
        loadingOption.textContent = 'Loading samples...';
        dropdown.appendChild(loadingOption);
        
        // Fetch recent samples
        fetch('/api/samples/recent')
        .then(response => response.json())
        .then(data => {
            // Clear dropdown
            dropdown.innerHTML = '';
            
            if (data.success && data.samples && data.samples.length > 0) {
                // Add samples to dropdown
                data.samples.forEach(sample => {
                    const option = document.createElement('option');
                    option.value = sample.SampleID;
                    option.textContent = `${sample.SampleIDFormatted}: ${sample.Description} (${sample.PartNumber || 'No part number'})`;
                    option.dataset.sample = JSON.stringify(sample);
                    dropdown.appendChild(option);
                });
            } else {
                // No samples found
                const noSamplesOption = document.createElement('option');
                noSamplesOption.textContent = 'No previous samples found';
                noSamplesOption.disabled = true;
                dropdown.appendChild(noSamplesOption);
            }
        })
        .catch(error => {
            dropdown.innerHTML = '';
            const errorOption = document.createElement('option');
            errorOption.textContent = 'Error loading samples';
            errorOption.disabled = true;
            dropdown.appendChild(errorOption);
            console.error('Error loading previous registrations:', error);
        });
    }
    
    // Helper function to show copy success message
    function showCopySuccess(sampleId) {
        const alert = document.getElementById('dataCopiedAlert');
        const message = document.getElementById('dataCopiedMessage');
        
        if (alert && message) {
            message.textContent = `Sample data copied from sample ${sampleId}. Please update amount and location as needed.`;
            alert.classList.remove('d-none');
            
            // Focus the first editable field that should be updated
            setTimeout(() => {
                document.querySelector('[name="totalAmount"]')?.focus();
            }, 300);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alert.classList.add('d-none');
            }, 5000);
        }
    }
    
    // Function to copy registration data from selected sample
    function copyRegistration() {
        const dropdown = document.getElementById('existingRegistrations');
        const selectedOption = dropdown.options[dropdown.selectedIndex];
        
        if (!selectedOption || !selectedOption.dataset.sample) {
            alert('Please select a valid sample to copy from');
            return;
        }
        
        try {
            // Parse the sample data from the option's dataset
            const sampleData = JSON.parse(selectedOption.dataset.sample);
            
            // Fill in form fields with sample data
            document.querySelector('[name="partNumber"]').value = sampleData.PartNumber || '';
            document.querySelector('[name="description"]').value = sampleData.Description || '';
            
            // Set unit if available
            const unitSelect = document.querySelector('[name="unit"]');
            if (unitSelect && sampleData.UnitID) {
                unitSelect.value = sampleData.UnitID;
            }
            
            // Don't copy amount - user needs to specify this
            
            // Set owner if available
            const ownerSelect = document.querySelector('[name="owner"]');
            if (ownerSelect && sampleData.OwnerID) {
                ownerSelect.value = sampleData.OwnerID;
            }
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('copyRegistrationModal'));
            modal.hide();
            
            // Show success message
            showCopySuccess(sampleData.SampleIDFormatted || 'Selected');
        } catch (error) {
            console.error('Error copying registration:', error);
            alert('Error copying registration data');
        }
    }
    
    // Set up event listeners once the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Set up copy registration modal to load data when opened
        document.getElementById('copyRegistrationModal').addEventListener('show.bs.modal', function() {
            loadPreviousRegistrations();
        });
        
        // Set up "use last registered sample" button with loading indicator
        document.getElementById('copyLastButton').addEventListener('click', function() {
            // Show loading state
            const button = this;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Loading...';
            button.disabled = true;
            
            fetch('/api/samples/last')
            .then(response => response.json())
            .then(data => {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
                
                if (data.success && data.sample) {
                    // Fill in form fields with sample data
                    document.querySelector('[name="partNumber"]').value = data.sample.PartNumber || '';
                    document.querySelector('[name="description"]').value = data.sample.Description || '';
                    
                    // Set unit if available
                    const unitSelect = document.querySelector('[name="unit"]');
                    if (unitSelect && data.sample.UnitID) {
                        unitSelect.value = data.sample.UnitID;
                    }
                    
                    // Don't copy amount - user needs to specify this
                    
                    // Set owner if available
                    const ownerSelect = document.querySelector('[name="owner"]');
                    if (ownerSelect && data.sample.OwnerID) {
                        ownerSelect.value = data.sample.OwnerID;
                    }
                    
                    // Set sample type if available (single, multiple, bulk)
                    if (data.sample.Type) {
                        const typeRadio = document.querySelector(`input[name="sampleTypeOption"][value="${data.sample.Type}"]`);
                        if (typeRadio) {
                            typeRadio.checked = true;
                            // Trigger change event to update related UI elements
                            typeRadio.dispatchEvent(new Event('change'));
                        }
                    }
                    
                    // Show success message
                    showCopySuccess(data.sample.SampleIDFormatted || 'Last');
                    
                    // Scroll to the top of step 2
                    document.getElementById('step2')?.scrollIntoView({ behavior: 'smooth' });
                } else {
                    // Show error in the alert area
                    const alert = document.getElementById('dataCopiedAlert');
                    const message = document.getElementById('dataCopiedMessage');
                    if (alert && message) {
                        alert.classList.remove('alert-success');
                        alert.classList.add('alert-warning');
                        message.textContent = 'No previous sample found to copy from';
                        alert.classList.remove('d-none');
                        
                        // Auto-hide after 3 seconds
                        setTimeout(() => {
                            alert.classList.add('d-none');
                            alert.classList.add('alert-success');
                            alert.classList.remove('alert-warning');
                        }, 3000);
                    } else {
                        // Fallback to alert if elements not found
                        alert('No previous sample found to copy from');
                    }
                }
            })
            .catch(error => {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
                
                console.error('Error fetching last sample:', error);
                
                // Show error in the alert area
                const alert = document.getElementById('dataCopiedAlert');
                const message = document.getElementById('dataCopiedMessage');
                if (alert && message) {
                    alert.classList.remove('alert-success');
                    alert.classList.add('alert-danger');
                    message.textContent = 'Error fetching last sample data. Please try again.';
                    alert.classList.remove('d-none');
                    
                    // Auto-hide after 3 seconds
                    setTimeout(() => {
                        alert.classList.add('d-none');
                        alert.classList.add('alert-success');
                        alert.classList.remove('alert-danger');
                    }, 3000);
                } else {
                    // Fallback to alert if elements not found
                    alert('Error fetching last sample');
                }
            });
        });
        
        // Initialize supplier search functionality
        console.log("Setting up supplier search");
        
        // Wait for DOM to be fully loaded to ensure all elements exist
        setTimeout(() => {
            // Store suppliers data
            const suppliers = [
                { id: "", name: "No supplier (internal sender)" }
                {% for supplier in suppliers %}
                , { id: "{{ supplier.SupplierID }}", name: "{{ supplier.SupplierName }}" }
                {% endfor %}
            ];
            
            console.log(`Found ${suppliers.length} suppliers`);
            
            const supplierSearchInput = document.getElementById('supplierSearchInput');
            const supplierResults = document.getElementById('supplierResults');
            const supplierIdInput = document.getElementById('supplierIdInput');
            const selectedSupplierDisplay = document.getElementById('selectedSupplierDisplay');
            const selectedSupplierName = document.getElementById('selectedSupplierName');
            const clearSupplierBtn = document.getElementById('clearSupplierBtn');
            
            if (!supplierSearchInput) console.error("Could not find supplierSearchInput");
            if (!supplierResults) console.error("Could not find supplierResults");
            if (!supplierIdInput) console.error("Could not find supplierIdInput");
        }, 100);
        
        setTimeout(() => {
            const supplierSearchInput = document.getElementById('supplierSearchInput');
            const supplierResults = document.getElementById('supplierResults');
            const supplierIdInput = document.getElementById('supplierIdInput');
            const selectedSupplierDisplay = document.getElementById('selectedSupplierDisplay');
            const selectedSupplierName = document.getElementById('selectedSupplierName');
            const clearSupplierBtn = document.getElementById('clearSupplierBtn');
            
            // Store suppliers data
            const suppliers = [
                { id: "", name: "No supplier (internal sender)" }
                {% for supplier in suppliers %}
                , { id: "{{ supplier.SupplierID }}", name: "{{ supplier.SupplierName }}" }
                {% endfor %}
            ];
            
            if (supplierSearchInput && supplierResults) {
                console.log(`Supplier search elements found - ${suppliers.length} suppliers available`);
                
                // Function to filter suppliers based on search text
                function filterSuppliers(searchText) {
                    if (!searchText) {
                        return suppliers;
                    }
                    
                    searchText = searchText.toLowerCase();
                    return suppliers.filter(supplier => 
                        supplier.name.toLowerCase().includes(searchText)
                    );
                }
                
                // Function to show filtered suppliers
                function showFilteredSuppliers(filteredSuppliers) {
                    console.log(`Showing ${filteredSuppliers.length} filtered suppliers`);
                    supplierResults.innerHTML = '';
                    
                    if (filteredSuppliers.length === 0) {
                        supplierResults.innerHTML = '<div class="supplier-search-empty">No suppliers found</div>';
                    } else {
                        filteredSuppliers.forEach(supplier => {
                            const item = document.createElement('div');
                            item.className = 'supplier-search-item';
                            item.dataset.id = supplier.id;
                            item.textContent = supplier.name;
                            
                            // Add click handler to select this supplier
                            item.addEventListener('click', function() {
                                selectSupplier(supplier.id, supplier.name);
                                supplierResults.classList.add('d-none');
                            });
                            
                            supplierResults.appendChild(item);
                        });
                    }
                    
                    // Show results
                    supplierResults.classList.remove('d-none');
                }
            
            // Function to select a supplier
            function selectSupplier(id, name) {
                supplierIdInput.value = id;
                
                if (id) {
                    selectedSupplierName.textContent = name;
                    selectedSupplierDisplay.classList.remove('d-none');
                    supplierSearchInput.placeholder = "Supplier selected";
                } else {
                    selectedSupplierName.textContent = "No supplier selected";
                    selectedSupplierDisplay.classList.add('d-none');
                    supplierSearchInput.placeholder = "Search for supplier...";
                }
                
                // Clear the search input
                supplierSearchInput.value = '';
            }
            
            // Add input handler with debouncing
            let debounceTimeout;
            supplierSearchInput.addEventListener('input', function() {
                clearTimeout(debounceTimeout);
                
                const searchText = this.value.trim();
                console.log("Input changed:", searchText);
                
                if (searchText) {
                    debounceTimeout = setTimeout(() => {
                        console.log("Debounce triggered for:", searchText);
                        const filteredSuppliers = filterSuppliers(searchText);
                        showFilteredSuppliers(filteredSuppliers);
                    }, 200);
                } else {
                    supplierResults.classList.add('d-none');
                }
            });
            
            // Handle keyboard navigation in the results
            supplierSearchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    // Close the results dropdown
                    supplierResults.classList.add('d-none');
                    this.blur();
                    return;
                }
                
                if (e.key === 'ArrowDown' && !supplierResults.classList.contains('d-none')) {
                    e.preventDefault();
                    // Focus the first item
                    const firstItem = supplierResults.querySelector('.supplier-search-item');
                    if (firstItem) {
                        firstItem.classList.add('active');
                        firstItem.focus();
                    }
                }
                
                if (e.key === 'Enter' && !supplierResults.classList.contains('d-none')) {
                    e.preventDefault();
                    // Select the first item
                    const firstItem = supplierResults.querySelector('.supplier-search-item');
                    if (firstItem) {
                        const id = firstItem.dataset.id;
                        const name = firstItem.textContent;
                        selectSupplier(id, name);
                        supplierResults.classList.add('d-none');
                    }
                }
            });
            
            // Handle keyboard navigation in the results list
            supplierResults.addEventListener('keydown', function(e) {
                const items = Array.from(this.querySelectorAll('.supplier-search-item'));
                const activeItem = this.querySelector('.supplier-search-item.active');
                const activeIndex = activeItem ? items.indexOf(activeItem) : -1;
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (activeIndex < items.length - 1) {
                        if (activeItem) {
                            activeItem.classList.remove('active');
                        }
                        items[activeIndex + 1].classList.add('active');
                        items[activeIndex + 1].focus();
                    }
                }
                
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (activeIndex > 0) {
                        activeItem.classList.remove('active');
                        items[activeIndex - 1].classList.add('active');
                        items[activeIndex - 1].focus();
                    } else {
                        // Focus back to the search input
                        if (activeItem) {
                            activeItem.classList.remove('active');
                        }
                        supplierSearchInput.focus();
                    }
                }
                
                if (e.key === 'Enter' && activeItem) {
                    e.preventDefault();
                    const id = activeItem.dataset.id;
                    const name = activeItem.textContent;
                    selectSupplier(id, name);
                    supplierResults.classList.add('d-none');
                }
                
                if (e.key === 'Escape') {
                    e.preventDefault();
                    supplierResults.classList.add('d-none');
                    supplierSearchInput.focus();
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!supplierSearchInput.contains(e.target) && !supplierResults.contains(e.target)) {
                    supplierResults.classList.add('d-none');
                }
            });
            
            // Clear button functionality
            if (clearSupplierBtn) {
                clearSupplierBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectSupplier('', '');
                });
            }
            
            // Focus the search input when clicking on it
            supplierSearchInput.addEventListener('focus', function() {
                if (this.value.trim()) {
                    const filteredSuppliers = filterSuppliers(this.value.trim());
                    showFilteredSuppliers(filteredSuppliers);
                }
            });
            
            // Initialize with "No supplier" selected
            selectSupplier('', '');
        } else {
            console.warn("Could not find supplier search elements");
        }
        }
    });
</script>

<!-- Define global handleFormSubmission function directly to ensure it's available -->
<script>
    // Define handleFormSubmission function globally to ensure it's accessible from all modules
    window.handleFormSubmission = function() {
        console.log('Using direct HTML handleFormSubmission function');
        
        // Collect form data
        const formData = {
            // Reception information
            supplier: document.querySelector('[name="supplier"]')?.value || '',
            trackingNumber: document.querySelector('[name="trackingNumber"]')?.value || '',
            custodian: document.querySelector('input[name="custodian"]')?.value || '',
            
            // Sample information
            partNumber: document.querySelector('[name="partNumber"]')?.value || '',
            description: document.querySelector('[name="description"]')?.value || '',
            
            // Sample type
            sampleType: document.querySelector('input[name="sampleTypeOption"]:checked')?.value || 'single',
            
            // Multiple samples info
            isMultiPackage: document.querySelector('input[name="sampleTypeOption"]:checked')?.value === 'multiple',
            packageCount: parseInt(document.querySelector('[name="packageCount"]')?.value) || 1,
            amountPerPackage: parseInt(document.querySelector('[name="amountPerPackage"]')?.value) || 1,
            separateStorage: document.getElementById('separateStorage')?.checked || false,
            
            // Amount information
            totalAmount: parseInt(document.querySelector('[name="totalAmount"]')?.value) || 0,
            unit: document.querySelector('[name="unit"]')?.value || '',
            
            // Storage type
            storageOption: document.querySelector('input[name="storageOption"]:checked')?.value || 'direct',
            
            // Additional fields
            owner: document.querySelector('[name="owner"]')?.value || '',
            expiryDate: document.querySelector('[name="expiryDate"]')?.value || '',
            hasSerialNumbers: document.getElementById('hasSerialNumbers')?.checked || false,
            other: document.querySelector('[name="other"]')?.value || '',
            
            // Location
            storageLocation: window.registerApp?.selectedLocation || document.getElementById('selectedLocationInput')?.value || '',
            
            // Container information
            createContainers: document.querySelector('input[name="storageOption"]:checked')?.value === 'container'
        };
        
        // Check if we need to handle separate storage for multiple samples without containers
        if (formData.sampleType === 'multiple' && formData.storageOption === 'direct' && formData.separateStorage) {
            console.log("Processing separate storage locations for multiple samples (direct storage)");
            
            // Use PackageLocations for tracking different locations
            if (typeof window.PackageLocations !== 'undefined') {
                // Get selected locations
                const packageLocations = window.PackageLocations.getSelectedLocations();
                
                // Ensure we have the right number of locations for all packages
                const packageCount = parseInt(document.querySelector('[name="packageCount"]')?.value) || 1;
                
                if (packageLocations.length !== packageCount) {
                    alert(`Error: You need to select ${packageCount} locations for your packages. Currently selected: ${packageLocations.length}`);
                    return false;
                }
                
                // Sort package locations by package number to ensure they're in order
                const sortedLocations = [...packageLocations].sort((a, b) => 
                    parseInt(a.packageNumber) - parseInt(b.packageNumber));
                
                // Add to formData
                formData.differentLocations = true;
                formData.packageLocations = sortedLocations.map(loc => ({
                    packageNumber: loc.packageNumber,
                    locationId: loc.locationId
                }));
                
                console.log('DEBUG: Using separate storage locations for multiple samples:', formData.packageLocations);
            }
        }
        
        // Show processing message
        const toast = document.createElement('div');
        toast.className = 'custom-toast success-toast show';
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">Processing</div>
                <div class="toast-message">Submitting your registration...</div>
            </div>
        `;
        document.body.appendChild(toast);
        
        // If containers are used, add container-specific data
        if (formData.createContainers) {
            console.log("Processing container data for API submission");
            // For single sample or bulk sample 
            if (formData.sampleType !== 'multiple') {
                const existingContainerOption = document.getElementById('existingContainerOption');
                if (existingContainerOption && existingContainerOption.checked) {
                    // Using existing container
                    formData.useExistingContainer = true;
                    formData.existingContainerId = document.getElementById('existingContainerSelect')?.value;
                    
                    // If we have container location, use it 
                    if (window.registerApp?.selectedContainerLocation) {
                        // Set all possible location ID field names for maximum compatibility
                        formData.storageLocation = window.registerApp.selectedContainerLocation.LocationID;
                        formData.locationId = window.registerApp.selectedContainerLocation.LocationID;
                        formData.containerLocationId = window.registerApp.selectedContainerLocation.LocationID;
                        console.log("DEBUG: Using container's location for storage:", window.registerApp.selectedContainerLocation.LocationID);
                    }
                } else {
                    // Create new container
                    formData.createContainers = true; // Explicitly set to match backend expectations
                    // Ensure we have a container description - critical for container creation
                    const containerDesc = document.getElementById('containerDescription')?.value || '';
                    formData.containerDescription = containerDesc || formData.description || 'Container';
                    // Clean up any leading/trailing whitespace
                    formData.containerDescription = formData.containerDescription.trim();
                    // Always ensure we have at least a basic name
                    if (!formData.containerDescription) {
                        formData.containerDescription = 'Container';   
                    }
                    console.log(`DEBUG: Using container description: '${formData.containerDescription}'`);
                    formData.containerIsMixed = document.getElementById('containerIsMixed')?.checked || false;
                    formData.containerTypeId = document.getElementById('containerType')?.value || '';
                    formData.containerCapacity = document.getElementById('containerCapacity')?.value || '';
                    
                    // Check if creating a new container type
                    // First try using the state from registerApp, otherwise check radio buttons
                    const createContainerType = (window.registerApp && window.registerApp.createNewContainerType !== undefined) 
                        ? window.registerApp.createNewContainerType 
                        : (document.getElementById('createNewTypeOption')?.checked || false);
                        
                    console.log("Adding container type creation info to form data. Creating new type:", createContainerType);
                    
                    if (createContainerType) {
                        formData.newContainerType = {
                            typeName: document.getElementById('newContainerTypeName')?.value || '',
                            description: document.getElementById('newContainerTypeDescription')?.value || '',
                            capacity: document.getElementById('newContainerTypeCapacity')?.value || ''
                        };
                        console.log("New container type data:", formData.newContainerType);
                    }
                    
                    // Get container location
                    const containerLocationSelect = document.getElementById('containerLocation');
                    if (containerLocationSelect && containerLocationSelect.value) {
                        formData.containerLocationId = containerLocationSelect.value;
                        // Also set the main storage location to the container location
                        formData.storageLocation = containerLocationSelect.value;
                    }
                }
            } else {
                // For multiple samples
                const oneContainerForAll = document.getElementById('oneContainerForAll');
                const oneContainerPerPackage = document.getElementById('oneContainerPerPackage');
                
                if (oneContainerForAll && oneContainerForAll.checked) {
                    // Creating one container for all samples
                    formData.createSingleContainer = true;
                    
                    // CRITICAL: Set flag to use single container for all packages
                    formData.useSingleContainerForAll = true;
                    
                    // Get container description and log it for debugging
                    const containerDesc = document.getElementById('containerDescription')?.value || '';
                    formData.containerDescription = containerDesc || formData.description || 'Container';
                    // Clean up any leading/trailing whitespace
                    formData.containerDescription = formData.containerDescription.trim();
                    // Always ensure we have at least a basic name
                    if (!formData.containerDescription) {
                        formData.containerDescription = 'Container';   
                    }
                    console.log(`DEBUG: Using container description for multiple samples: '${formData.containerDescription}'`);
                    formData.containerIsMixed = document.getElementById('containerIsMixed')?.checked || false;
                    formData.containerTypeId = document.getElementById('containerType')?.value || '';
                    formData.containerCapacity = document.getElementById('containerCapacity')?.value || '';

                    // Check if creating a new container type
                    // First try using the state from registerApp, otherwise check radio buttons
                    const createContainerType = (window.registerApp && window.registerApp.createNewContainerType !== undefined) 
                        ? window.registerApp.createNewContainerType 
                        : (document.getElementById('createNewTypeOption')?.checked || false);
                        
                    console.log("Adding container type creation info to form data. Creating new type:", createContainerType);
                    
                    if (createContainerType) {
                        formData.newContainerType = {
                            typeName: document.getElementById('newContainerTypeName')?.value || '',
                            description: document.getElementById('newContainerTypeDescription')?.value || '',
                            capacity: document.getElementById('newContainerTypeCapacity')?.value || ''
                        };
                        console.log("New container type data:", formData.newContainerType);
                    }
                    
                    // Container location - get from text input 
                    const containerLocationInput = document.getElementById('containerLocation');
                    if (containerLocationInput && containerLocationInput.value.trim()) {
                        const locationValue = containerLocationInput.value.trim();
                        // Store the location name exactly as entered
                        formData.containerLocationName = locationValue;
                        // For API compatibility
                        formData.containerLocationId = locationValue;
                        // Also set the main storage location
                        formData.storageLocation = locationValue;
                        
                        console.log("Using container location from input:", locationValue);
                    }
                } else if (oneContainerPerPackage && oneContainerPerPackage.checked) {
                    // Creating one container per package
                    formData.createMultipleContainers = true;
                    formData.isMultiPackage = true;  // CRITICAL: Explicitly set this flag to true
                    formData.sampleType = 'multiple'; // CRITICAL: Ensure backend knows this is multiple samples
                    formData.multiContainerOption = 'multiple'; // Set this flag for API compatibility
                    
                    // Include any additional flags from storage grid validation
                    if (window._multipleContainersFormData) {
                        Object.assign(formData, window._multipleContainersFormData);
                        console.log("DEBUG: Merged additional flags from storage grid validation:", window._multipleContainersFormData);
                    }
                    
                    // Get container description and log it for debugging
                    const containerDesc = document.getElementById('containerDescription')?.value || '';
                    formData.containerDescription = containerDesc || formData.description || 'Container';
                    // Clean up any leading/trailing whitespace
                    formData.containerDescription = formData.containerDescription.trim();
                    // Always ensure we have at least a basic name
                    if (!formData.containerDescription) {
                        formData.containerDescription = 'Container';   
                    }
                    
                    // Set package count and amount per package explicitly
                    const packageCount = parseInt(document.querySelector('[name="packageCount"]')?.value) || 1;
                    const amountPerPackage = parseInt(document.querySelector('[name="amountPerPackage"]')?.value) || 1;
                    formData.packageCount = packageCount;
                    formData.amountPerPackage = amountPerPackage;
                    console.log(`DEBUG: Using ${packageCount} packages with ${amountPerPackage} samples per package`);
                    
                    console.log(`DEBUG: Using container description for multiple samples: '${formData.containerDescription}'`);
                    formData.containerIsMixed = document.getElementById('containerIsMixed')?.checked || false;
                    formData.containerTypeId = document.getElementById('containerType')?.value || '';
                    formData.containerCapacity = document.getElementById('containerCapacity')?.value || '';
                    
                    // CRITICAL: Explicitly set containerLocationId to null for "one container per package"
                    // This prevents backend from expecting a specific location
                    formData.containerLocationId = null;
                    
                    // CRITICAL: Explicitly set container location to null to prevent backend from expecting it
                    formData.containerLocationId = null;

                    // For multiple containers, get package locations
                    if (typeof window.PackageLocations !== 'undefined') {
                        // Log state for debug
                        console.log('DEBUG: PackageLocations state before submission:');
                        window.PackageLocations.dumpState();
                        
                        // Get selected locations
                        const packageLocations = window.PackageLocations.getSelectedLocations();
                        console.log('DEBUG: Package locations for multiple containers:', packageLocations);
                        
                        // Get separate storage status
                        const separateStorage = document.getElementById('separateStorage')?.checked || false;
                        console.log('DEBUG: Separate storage enabled:', separateStorage);
                        
                        // CRITICAL FIX: Only enforce all locations when separate storage is enabled
                        // Otherwise we just need at least one location
                        
                        if (packageLocations.length === 0) {
                            // No locations at all - this is always an error
                            alert('Error: Please select at least one storage location in the grid.');
                            
                            // Remove processing toast if showing
                            toast.remove();
                            
                            // Prevent form submission
                            return false;
                        }
                        else if (separateStorage && packageLocations.length !== packageCount) {
                            // When separate storage is enabled, we need exactly one location per package
                            alert(`Error: You need to select ${packageCount} locations for your packages. Currently selected: ${packageLocations.length}. Each package needs its own location.`);
                            
                            // Remove processing toast if showing
                            toast.remove();
                            
                            // Prevent form submission
                            return false;
                        }
                        
                        // If we get here, either:
                        // 1. separate storage is enabled and we have exactly the right number of locations, or
                        // 2. separate storage is disabled and we have at least one location (will use first)
                        console.log(`Validation passed with ${packageLocations.length} locations, separateStorage=${separateStorage}, packageCount=${packageCount}`);
                        
                        // Sort package locations by package number to ensure they're in order
                        const sortedLocations = [...packageLocations].sort((a, b) => 
                            parseInt(a.packageNumber) - parseInt(b.packageNumber));
                        
                        // Set both formats for backend compatibility
                        formData.containerLocations = sortedLocations.map(loc => ({
                            packageNumber: loc.packageNumber,
                            locationId: loc.locationId
                        }));
                        
                        // Set differentLocations based on separate storage checkbox
                        formData.differentLocations = separateStorage;
                        formData.useSeparateStorage = separateStorage; // Make this explicit for the backend
                        
                        formData.packageLocations = sortedLocations.map(loc => ({
                            packageNumber: loc.packageNumber,
                            locationId: loc.locationId
                        }));
                        
                        // Log packaged data
                        console.log('DEBUG: Sending container locations:', formData.containerLocations, 
                                   'useSeparateStorage:', separateStorage);
                        
                        // CRITICAL FLAGS - set all needed flags to ensure multiple samples are created
                        formData.createMultipleContainers = true;
                        formData.createSingleContainer = false; // Ensure this is NOT set for multiple containers
                    } else {
                        console.error("PackageLocations module not available but oneContainerPerPackage is checked");
                        alert("Error: Package location tracking is not available. Please refresh the page and try again.");
                        
                        // Remove processing toast if showing
                        toast.remove();
                        
                        // Prevent form submission
                        return false;
                    }
                }
            }
            console.log("Container data prepared:", formData);
        }
        
        // Send data to server
        fetch('/api/samples', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            // Remove processing toast
            toast.remove();
            
            if (data.success) {
                // Show success message
                const successToast = document.createElement('div');
                successToast.className = 'custom-toast success-toast show';
                successToast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">Success</div>
                        <div class="toast-message">Sample ${data.sample_id} has been registered successfully!</div>
                    </div>
                `;
                document.body.appendChild(successToast);
                
                // Redirect to dashboard after 2 seconds
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            } else {
                // Show error toast
                const errorToast = document.createElement('div');
                errorToast.className = 'custom-toast error-toast show';
                errorToast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">Error</div>
                        <div class="toast-message">Error during registration: ${data.error || 'Unknown error'}</div>
                    </div>
                `;
                document.body.appendChild(errorToast);
            }
        })
        .catch(error => {
            // Remove processing toast
            toast.remove();
            
            // Show error toast
            const errorToast = document.createElement('div');
            errorToast.className = 'custom-toast error-toast show';
            errorToast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">Error</div>
                    <div class="toast-message">An error occurred: ${error.message || 'Unknown error'}</div>
                </div>
            `;
            document.body.appendChild(errorToast);
        });
    };

    // Function to update container location visibility based on multiple container selection
    function updateContainerLocationVisibility() {
        console.log("updateContainerLocationVisibility called");
        const oneContainerPerPackage = document.getElementById('oneContainerPerPackage');
        const containerLocationSection = document.getElementById('containerLocationSelectSection');
        const multiLocationInfo = document.getElementById('multiLocationInfo');
        
        if (oneContainerPerPackage && containerLocationSection) {
            // Hide location dropdown when "one container per package" is selected
            if (oneContainerPerPackage.checked) {
                // Hide location dropdown
                containerLocationSection.classList.add('d-none');
                // Remove required attribute when hidden
                const containerLocationSelect = document.getElementById('containerLocation');
                if (containerLocationSelect) {
                    containerLocationSelect.removeAttribute('required');
                    // Clear any selected value to prevent it from being submitted
                    containerLocationSelect.value = '';
                }
                
                // Show the multi-location info alert
                if (multiLocationInfo) {
                    multiLocationInfo.style.display = 'block';
                }
                
                // REMOVE automatic checking of "separate storage" checkbox
                // This lets users decide if they want separate storage or not
                const separateStorage = document.getElementById('separateStorage');
                if (separateStorage) {
                    // Do NOT force checked state
                    // Do NOT disable the checkbox - let users change it
                    
                    // Just trigger associated events to update the UI
                    separateStorage.dispatchEvent(new Event('change'));
                }
            } else {
                // Show location dropdown
                containerLocationSection.classList.remove('d-none');
                // Add required attribute when visible
                const containerLocationSelect = document.getElementById('containerLocation');
                if (containerLocationSelect) {
                    containerLocationSelect.setAttribute('required', 'required');
                }
                
                // Hide the multi-location info alert
                if (multiLocationInfo) {
                    multiLocationInfo.style.display = 'none';
                }
                
                // Re-enable the separate storage checkbox
                const separateStorage = document.getElementById('separateStorage');
                if (separateStorage) {
                    separateStorage.disabled = false;
                }
            }
        }
    }
    
    // Create fallback for PackageLocations module if not loaded
    if (!window.PackageLocations) {
        console.warn("PackageLocations module not loaded, creating fallback");
        window.PackageLocations = {
            _locations: [],
            
            addLocation: function(packageNumber, locationId, locationName) {
                this._locations.push({packageNumber, locationId, locationName});
            },
            
            removeLocation: function(packageNumber) {
                this._locations = this._locations.filter(loc => loc.packageNumber != packageNumber);
            },
            
            removeLocationByName: function(locationName) {
                this._locations = this._locations.filter(loc => loc.locationName !== locationName);
            },
            
            getSelectedLocations: function() {
                return this._locations;
            },
            
            getLocationByPackage: function(packageNumber) {
                return this._locations.find(loc => loc.packageNumber == packageNumber);
            },
            
            reset: function() {
                this._locations = [];
            }
        };
    }
</script>

<!-- Load the main registration helper first with global state management -->
<script src="{{ url_for('static', filename='js/register.js') }}"></script>

<!-- Load core validation module first - has critical functions -->
<script src="{{ url_for('static', filename='js/register-validation.js') }}"></script>


<!-- Make sure core functions are available before proceeding -->
<script>
    // Check if the validation module loaded correctly
    if (typeof window.validateCurrentStep !== 'function' || 
        typeof window.handleFormSubmission !== 'function' ||
        typeof window.updateRegistrationSummary !== 'function') {
        
        console.error('Critical functions missing after loading validation module');
    } else {
        console.log('Validation module loaded successfully with all critical functions');
    }
    
    // Define global updateContainerLocationVisibility function to ensure it's available everywhere
    window.updateContainerLocationVisibility = function() {
        const oneContainerPerPackage = document.getElementById('oneContainerPerPackage');
        const containerLocationSection = document.getElementById('containerLocationSelectSection');
        const multiLocationInfo = document.getElementById('multiLocationInfo');
        
        if (oneContainerPerPackage && containerLocationSection) {
            // Hide location dropdown when "one container per package" is selected
            if (oneContainerPerPackage.checked) {
                // Hide location dropdown
                containerLocationSection.classList.add('d-none');
                // Remove required attribute when hidden
                const containerLocationSelect = document.getElementById('containerLocation');
                if (containerLocationSelect) {
                    containerLocationSelect.removeAttribute('required');
                    // Clear any selected value to prevent it from being submitted
                    containerLocationSelect.value = '';
                }
                
                // Show the multi-location info alert
                if (multiLocationInfo) {
                    multiLocationInfo.style.display = 'block';
                }
                
                // REMOVE automatic checking of "separate storage" checkbox
                // This lets users decide if they want separate storage or not
                const separateStorage = document.getElementById('separateStorage');
                if (separateStorage) {
                    // Do NOT force checked state
                    // Do NOT disable the checkbox - let users change it
                    
                    // Just trigger associated events to update the UI
                    separateStorage.dispatchEvent(new Event('change'));
                }
            } else {
                // Show location dropdown
                containerLocationSection.classList.remove('d-none');
                // Add required attribute when visible
                const containerLocationSelect = document.getElementById('containerLocation');
                if (containerLocationSelect) {
                    containerLocationSelect.setAttribute('required', 'required');
                }
                
                // Hide the multi-location info alert
                if (multiLocationInfo) {
                    multiLocationInfo.style.display = 'none';
                }
                
                // Re-enable the separate storage checkbox
                const separateStorage = document.getElementById('separateStorage');
                if (separateStorage) {
                    separateStorage.disabled = false;
                }
            }
        }
    };
</script>

<!-- Load form handling module next -->
<script src="{{ url_for('static', filename='js/register-form.js') }}"></script>

<!-- Then include other modules -->
<script src="{{ url_for('static', filename='js/register-sample-types.js') }}"></script>
<script src="{{ url_for('static', filename='js/register-containers.js') }}"></script>
<script src="{{ url_for('static', filename='js/register-storage.js') }}"></script>
<script src="{{ url_for('static', filename='js/register-identification.js') }}"></script>

<script>
    // Define fully functional backup implementations directly in the HTML
    (function() {
        // Define real backup form submission function
        if (typeof window.handleFormSubmission !== 'function') {
            console.warn('Defining complete backup handleFormSubmission');
            window.handleFormSubmission = function() {
                console.log('Using backup form submission function');
                
                // Validate current step first
                if (typeof window.validateCurrentStep === 'function' && !window.validateCurrentStep()) {
                    return;
                }
                
                // Collect all data from form
                const formData = {
                    // Reception information
                    supplier: document.querySelector('[name="supplier"]')?.value || '',
                    trackingNumber: document.querySelector('[name="trackingNumber"]')?.value || '',
                    custodian: document.querySelector('input[name="custodian"]')?.value || '',
                    
                    // Sample information
                    partNumber: document.querySelector('[name="partNumber"]')?.value || '',
                    description: document.querySelector('[name="description"]')?.value || '',
                    
                    // Sample type
                    sampleType: document.querySelector('input[name="sampleTypeOption"]:checked')?.value || 'single',
                    
                    // Amount information
                    totalAmount: parseInt(document.querySelector('[name="totalAmount"]')?.value) || 0,
                    unit: document.querySelector('[name="unit"]')?.value || '',
                    
                    // Storage type
                    storageOption: document.querySelector('input[name="storageOption"]:checked')?.value || 'direct',
                    
                    // Additional fields
                    owner: document.querySelector('[name="owner"]')?.value || '',
                    expiryDate: document.querySelector('[name="expiryDate"]')?.value || '',
                    hasSerialNumbers: document.getElementById('hasSerialNumbers')?.checked || false,
                    other: document.querySelector('[name="other"]')?.value || '',
                    
                    // Location
                    storageLocation: window.registerApp?.selectedLocation || document.getElementById('selectedLocationInput')?.value || '',
                    
                    // Container information
                    storageOption: document.querySelector('input[name="storageOption"]:checked')?.value || 'direct',
                    createContainers: document.querySelector('input[name="storageOption"]:checked')?.value === 'container'
                };
                
                // Add multiple samples specific data
                if (formData.sampleType === 'multiple') {
                    formData.packageCount = parseInt(document.querySelector('[name="packageCount"]')?.value) || 1;
                    formData.amountPerPackage = parseInt(document.querySelector('[name="amountPerPackage"]')?.value) || 1;
                    formData.separateStorage = document.getElementById('separateStorage')?.checked || false;
                    
                    // If using separate storage for each package
                    if (formData.separateStorage) {
                        if (window.PackageLocations && typeof PackageLocations.getSelectedLocations === 'function') {
                            const packageLocations = PackageLocations.getSelectedLocations();
                            formData.packageLocations = packageLocations.map(loc => ({
                                packageNumber: loc.packageNumber,
                                locationId: loc.locationId
                            }));
                            console.log("Using package locations:", formData.packageLocations);
                        } else {
                            console.error("PackageLocations module not found for multiple locations");
                        }
                    }
                }
                
                // If containers are used, add container-specific data
                if (formData.createContainers) {
                    // For single sample - check if using existing or creating new container
                    if (formData.sampleType !== 'multiple') {
                        const existingContainerOption = document.getElementById('existingContainerOption');
                        if (existingContainerOption && existingContainerOption.checked) {
                            // Using existing container
                            formData.useExistingContainer = true;
                            formData.existingContainerId = document.getElementById('existingContainerSelect')?.value;
                            
                            // If we have container location, use it
                            if (window.registerApp?.selectedContainerLocation) {
                                // Set all possible location ID field names for maximum compatibility
                                formData.storageLocation = window.registerApp.selectedContainerLocation.LocationID;
                                formData.locationId = window.registerApp.selectedContainerLocation.LocationID;
                                formData.containerLocationId = window.registerApp.selectedContainerLocation.LocationID;
                                console.log("DEBUG: Using container's location for storage in backup function:", window.registerApp.selectedContainerLocation.LocationID);
                            }
                        } else {
                            // Use correct API fields for container creation
                            formData.containerDescription = document.getElementById('containerDescription')?.value || '';
                            formData.containerIsMixed = document.getElementById('containerIsMixed')?.checked || false;
                            
                            // Ensure containerTypeId is a number
                            const typeId = document.getElementById('containerType')?.value;
                            formData.containerTypeId = typeId ? parseInt(typeId) : null;
                            
                            // Ensure capacity is a number
                            const capacity = document.getElementById('containerCapacity')?.value;
                            formData.containerCapacity = capacity ? parseInt(capacity) : null;
                            
                            // Creating new container type?
                            const createContainerType = document.getElementById('createContainerType')?.checked || false;
                            if (createContainerType) {
                                formData.newContainerType = {
                                    typeName: document.getElementById('newContainerTypeName')?.value || '',
                                    description: document.getElementById('newContainerTypeDescription')?.value || '',
                                    capacity: document.getElementById('newContainerTypeCapacity')?.value || ''
                                };
                            }
                            
                            // Container location - ensure it's a number
                            const containerLocationValue = document.getElementById('containerLocation')?.value || '';
                            formData.containerLocationId = containerLocationValue ? parseInt(containerLocationValue) : null;
                        }
                    } else {
                        // For multiple samples
                        const oneContainerForAll = document.getElementById('oneContainerForAll');
                        const oneContainerPerPackage = document.getElementById('oneContainerPerPackage');
                        
                        if (oneContainerForAll && oneContainerForAll.checked) {
                            // Creating one container for all samples
                            formData.createSingleContainer = true;
                            formData.containerDescription = document.getElementById('containerDescription')?.value || '';
                            formData.containerIsMixed = document.getElementById('containerIsMixed')?.checked || false;
                            formData.containerTypeId = document.getElementById('containerType')?.value || '';
                            formData.containerCapacity = document.getElementById('containerCapacity')?.value || '';
                            
                            // Creating new container type?
                            const createContainerType = document.getElementById('createContainerType')?.checked || false;
                            if (createContainerType) {
                                formData.newContainerType = {
                                    typeName: document.getElementById('newContainerTypeName')?.value || '',
                                    description: document.getElementById('newContainerTypeDescription')?.value || '',
                                    capacity: document.getElementById('newContainerTypeCapacity')?.value || ''
                                };
                            }
                            
                            // Container location - ensure it's a number
                            const locationId = document.getElementById('containerLocation')?.value || registerApp.selectedLocation || '';
                            formData.containerLocationId = locationId ? parseInt(locationId) : null;
                            
                            // Logging to help debug
                            console.log('Container data for one container:', {
                                createContainers: formData.createContainers,
                                containerDescription: formData.containerDescription,
                                containerTypeId: formData.containerTypeId,
                                containerIsMixed: formData.containerIsMixed,
                                containerCapacity: formData.containerCapacity,
                                containerLocationId: formData.containerLocationId
                            });
                        } else if (oneContainerPerPackage && oneContainerPerPackage.checked) {
                            // Creating one container per package
                            formData.createMultipleContainers = true;
                            formData.containerDescription = document.getElementById('containerDescription')?.value || '';
                            formData.containerIsMixed = document.getElementById('containerIsMixed')?.checked || false;
                            formData.containerTypeId = document.getElementById('containerType')?.value || '';
                            
                            // Container locations from package locations
                            if (window.PackageLocations && typeof PackageLocations.getSelectedLocations === 'function') {
                                const packageLocations = PackageLocations.getSelectedLocations();
                                formData.containerLocations = packageLocations.map(loc => ({
                                    packageNumber: loc.packageNumber,
                                    locationId: loc.locationId
                                }));
                            }
                        }
                    }
                }
                
                console.log("Sending form data:", formData);
                
                // Show a processing message
                const toast = document.createElement('div');
                toast.className = 'custom-toast success-toast show';
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">Processing</div>
                        <div class="toast-message">Submitting your registration...</div>
                    </div>
                `;
                document.body.appendChild(toast);
                
                // Send data to server
                fetch('/api/samples', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    // Remove the processing toast
                    toast.remove();
                    
                    if (data.success) {
                        // Show success message
                        const successToast = document.createElement('div');
                        successToast.className = 'custom-toast success-toast show';
                        successToast.innerHTML = `
                            <div class="toast-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="toast-content">
                                <div class="toast-title">Success</div>
                                <div class="toast-message">Sample ${data.sample_id} has been registered successfully!</div>
                            </div>
                        `;
                        document.body.appendChild(successToast);
                        
                        // Redirect to dashboard after 2 seconds
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 2000);
                    } else {
                        // Show error message
                        const errorToast = document.createElement('div');
                        errorToast.className = 'custom-toast error-toast show';
                        errorToast.innerHTML = `
                            <div class="toast-icon">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="toast-content">
                                <div class="toast-title">Error</div>
                                <div class="toast-message">Error during registration: ${data.error}</div>
                            </div>
                        `;
                        document.body.appendChild(errorToast);
                    }
                })
                .catch(error => {
                    // Remove the processing toast
                    toast.remove();
                    
                    // Show error message
                    const errorToast = document.createElement('div');
                    errorToast.className = 'custom-toast error-toast show';
                    errorToast.innerHTML = `
                        <div class="toast-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="toast-content">
                            <div class="toast-title">Error</div>
                            <div class="toast-message">An error occurred during submission: ${error}</div>
                        </div>
                    `;
                    document.body.appendChild(errorToast);
                });
            };
        }
        
        // Define backup validation function
        if (typeof window.validateCurrentStep !== 'function') {
            console.warn('Defining backup validateCurrentStep');
            window.validateCurrentStep = function() { 
                const currentStep = window.registerApp?.currentStep || 4;
                
                // For the last step (location), check if a location is selected
                if (currentStep === 4) {
                    if (!window.registerApp?.selectedLocation) {
                        alert('Please select a location by clicking on an available space in the grid.');
                        return false;
                    }
                }
                
                return true; 
            };
        }
        
        // Define backup summary function
        if (typeof window.updateRegistrationSummary !== 'function') {
            console.warn('Defining backup updateRegistrationSummary');
            window.updateRegistrationSummary = function() { 
                console.log('Using backup summary update function'); 
                
                const summaryContent = document.getElementById('summaryContent');
                if (summaryContent) {
                    const description = document.querySelector('[name="description"]')?.value || 'Sample';
                    const amount = document.querySelector('[name="totalAmount"]')?.value || '1';
                    const unit = document.querySelector('[name="unit"] option:checked')?.textContent || 'pcs';
                    
                    summaryContent.innerHTML = `
                        <div class="alert alert-info">
                            <p><strong>${description}</strong> - ${amount} ${unit}</p>
                            <p>Your sample will be registered with the selected options.</p>
                        </div>
                    `;
                }
            };
        }
    })();
    
    // Initialize container module when document is loaded
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof ContainerModule !== 'undefined') {
            ContainerModule.init();
        }
        
        // Initialize container location visibility
        if (typeof window.updateContainerLocationVisibility === 'function') {
            window.updateContainerLocationVisibility();
        }
        
        // Container type radio button toggling
        const useExistingTypeOption = document.getElementById('useExistingTypeOption');
        const createNewTypeOption = document.getElementById('createNewTypeOption');
        
        if (useExistingTypeOption && createNewTypeOption) {
            // Function to handle container type option change
            function handleContainerTypeOptionChange() {
                const existingTypeSection = document.getElementById('existingContainerTypeSection');
                const newTypeSection = document.getElementById('newContainerTypeSection');
                const containerTypeSelect = document.getElementById('containerType');
                const containerCapacityInput = document.getElementById('containerCapacity');
                const newTypeNameInput = document.getElementById('newContainerTypeName');
                const newTypeCapacityInput = document.getElementById('newContainerTypeCapacity');
                
                // Check which option is selected
                const createNew = createNewTypeOption.checked;
                
                // Show/hide appropriate sections
                if (existingTypeSection) existingTypeSection.classList.toggle('d-none', createNew);
                if (newTypeSection) newTypeSection.classList.toggle('d-none', !createNew);
                
                // Manage required fields and focus
                if (containerTypeSelect) {
                    containerTypeSelect.required = !createNew;
                    containerTypeSelect.disabled = createNew;
                }
                
                if (newTypeNameInput) newTypeNameInput.required = createNew;
                if (newTypeCapacityInput) newTypeCapacityInput.required = createNew;
                
                // Focus the appropriate field
                if (createNew) {
                    setTimeout(() => {
                        newTypeNameInput?.focus();
                    }, 100);
                } else {
                    setTimeout(() => {
                        containerTypeSelect?.focus();
                    }, 100);
                }
                
                // Store in global state for form submission
                if (window.registerApp) {
                    window.registerApp.createNewContainerType = createNew;
                    console.log("Container type creation state updated in global state:", createNew);
                }
            }
            
            // Add event listeners to both radio buttons
            useExistingTypeOption.addEventListener('change', handleContainerTypeOptionChange);
            createNewTypeOption.addEventListener('change', handleContainerTypeOptionChange);
            
            // Initial setup
            handleContainerTypeOptionChange();
        }
        
        // Define updateContainerLocationVisibility as a local function
        function updateContainerLocationVisibility() {
            const oneContainerPerPackage = document.getElementById('oneContainerPerPackage');
            const containerLocationSection = document.getElementById('containerLocationSelectSection');
            const multiLocationInfo = document.getElementById('multiLocationInfo');
            
            if (oneContainerPerPackage && containerLocationSection) {
                // Hide location dropdown when "one container per package" is selected
                if (oneContainerPerPackage.checked) {
                    // Hide location dropdown
                    containerLocationSection.classList.add('d-none');
                    // Remove required attribute when hidden
                    const containerLocationSelect = document.getElementById('containerLocation');
                    if (containerLocationSelect) {
                        containerLocationSelect.removeAttribute('required');
                        // Clear any selected value to prevent it from being submitted
                        containerLocationSelect.value = '';
                    }
                    
                    // Show the multi-location info alert
                    if (multiLocationInfo) {
                        multiLocationInfo.style.display = 'block';
                    }
                    
                    // Auto-check the "separate storage" checkbox for multiple storage
                    const separateStorage = document.getElementById('separateStorage');
                    if (separateStorage) {
                        separateStorage.checked = true;
                        // Disable the checkbox to prevent changes when in this mode
                        separateStorage.disabled = true;
                        // Trigger any associated events
                        separateStorage.dispatchEvent(new Event('change'));
                    }
                } else {
                    // Show location dropdown
                    containerLocationSection.classList.remove('d-none');
                    // Add required attribute when visible
                    const containerLocationSelect = document.getElementById('containerLocation');
                    if (containerLocationSelect) {
                        containerLocationSelect.setAttribute('required', 'required');
                    }
                    
                    // Hide the multi-location info alert
                    if (multiLocationInfo) {
                        multiLocationInfo.style.display = 'none';
                    }
                    
                    // Re-enable the separate storage checkbox
                    const separateStorage = document.getElementById('separateStorage');
                    if (separateStorage) {
                        separateStorage.disabled = false;
                    }
                }
            }
        }
        
        // Call this function initially to set up the visibility
        setTimeout(updateContainerLocationVisibility, 0);
        
        // Setup container type selection to automatically set capacity
        const containerDescriptionInput = document.getElementById('containerDescription');
        const containerTypeSelect = document.getElementById('containerType');
        const containerCapacityInput = document.getElementById('containerCapacity');
        
        // When container type changes, update the capacity field with default capacity
        if (containerTypeSelect && containerCapacityInput) {
            containerTypeSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.dataset.capacity) {
                    const defaultCapacity = parseInt(selectedOption.dataset.capacity);
                    if (!isNaN(defaultCapacity)) {
                        // Set the capacity field to the default capacity
                        containerCapacityInput.value = defaultCapacity;
                        // Do not make it readonly - just highlight that it has a default value
                        containerCapacityInput.classList.add('bg-light');
                    }
                } else {
                    // If no type is selected or it has no default capacity, 
                    // clear formatting and value
                    containerCapacityInput.classList.remove('bg-light');
                    containerCapacityInput.value = '';
                }
            });
            
            // Trigger the change event to set initial capacity if a type is already selected
            if (containerTypeSelect.value) {
                containerTypeSelect.dispatchEvent(new Event('change'));
            }
        }
        
        // Handle create container type checkbox to properly manage container type selection
        if (containerTypeSelect) {
            const containerTypeCheckbox = document.getElementById('createContainerType');
            if (containerTypeCheckbox) {
                containerTypeCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        // When creating a new type, disable the container type selection
                        containerTypeSelect.setAttribute('disabled', true);
                        containerTypeSelect.classList.add('bg-light');
                        // Make capacity editable (remove visual styling)
                        if (containerCapacityInput) {
                            containerCapacityInput.classList.remove('bg-light');
                        }
                    } else {
                        // When not creating a new type, enable the container type selection
                        containerTypeSelect.removeAttribute('disabled');
                        containerTypeSelect.classList.remove('bg-light');
                        
                        // Trigger the change event to reset capacity based on selected type
                        if (containerTypeSelect.value) {
                            containerTypeSelect.dispatchEvent(new Event('change'));
                        }
                    }
                });
            }
        }
        
        // Hijack form submission to add enhanced validation
        const originalHandleFormSubmission = window.handleFormSubmission;
        if (typeof originalHandleFormSubmission === 'function') {
            window.handleFormSubmission = function() {
                // Check if container creation is selected
                const isContainerStorage = document.querySelector('input[name="storageOption"]:checked')?.value === 'container';
                if (isContainerStorage) {
                    // Check if we're creating a new container
                    const isNewContainer = !document.getElementById('existingContainerOption')?.checked;
                    
                    if (isNewContainer) {
                        // Container description is required
                        const containerDescription = document.getElementById('containerDescription')?.value?.trim();
                        if (!containerDescription) {
                            alert('Error: Container Description is required. Please provide a descriptive name for the container.');
                            document.getElementById('containerDescription')?.focus();
                            return false; // Prevent form submission
                        }
                        
                        // Check container type based on radio button selection
                        const isCreatingNewType = document.getElementById('createNewTypeOption')?.checked || false;
                        
                        if (isCreatingNewType) {
                            // Validate new container type fields
                            const typeName = document.getElementById('newContainerTypeName')?.value?.trim();
                            const capacity = document.getElementById('newContainerTypeCapacity')?.value?.trim();
                            
                            if (!typeName) {
                                alert('Error: Container Type Name is required when creating a new container type.');
                                document.getElementById('newContainerTypeName')?.focus();
                                return false;
                            }
                            
                            if (!capacity) {
                                alert('Error: Container Capacity is required when creating a new container type.');
                                document.getElementById('newContainerTypeCapacity')?.focus();
                                return false;
                            }
                        } else {
                            // Validate selected container type
                            const containerTypeId = document.getElementById('containerType')?.value;
                            if (!containerTypeId) {
                                alert('Error: Please select a container type or create a new one.');
                                document.getElementById('containerType')?.focus();
                                return false; // Prevent form submission
                            }
                        }
                        
                        // Check if we're in "one container per package" mode
                        const oneContainerPerPackage = document.getElementById('oneContainerPerPackage')?.checked || false;
                        const multiContainerOption = document.querySelector('input[name="multiContainerOption"]:checked')?.value;
                        const isMultiContainerMode = oneContainerPerPackage || multiContainerOption === 'multiple';
                        
                        // If we're in multi-container mode, skip the containerLocation check
                        // because it uses package locations from grid view instead
                        if (!isMultiContainerMode) {
                            // Only check container location for single container mode
                            const containerLocation = document.getElementById('containerLocation')?.value;
                            if (!containerLocation) {
                                alert('Error: Please enter a storage location for the container in format x.x.x (e.g. 1.1.1).');
                                document.getElementById('containerLocation')?.focus();
                                return false;
                            }
                            
                            // Check location format
                            const locationRegex = /^\d+\.\d+\.\d+$/;
                            if (!locationRegex.test(containerLocation)) {
                                alert('Error: Please enter a valid location in format x.x.x (e.g. 1.1.1).');
                                document.getElementById('containerLocation')?.focus();
                                return false;
                            }
                        } else {
                            console.log("Skipping containerLocation check in one-container-per-package mode");
                        }
                    } else {
                        // Using existing container
                        const existingContainerId = document.getElementById('existingContainerSelect')?.value;
                        if (!existingContainerId) {
                            alert('Error: Please select an existing container from the dropdown.');
                            document.getElementById('existingContainerSelect')?.focus();
                            return false;
                        }
                    }
                }
                
                // Everything validated, call the original handler
                return originalHandleFormSubmission();
            };
        }
        
        // Log loading status and critical functions
        console.log('All registration scripts loaded. Module status:', 
            window.registerApp ? window.registerApp.modulesLoaded : 'registerApp not defined');
        
        console.log('Critical functions available:', {
            handleFormSubmission: typeof window.handleFormSubmission === 'function',
            validateCurrentStep: typeof window.validateCurrentStep === 'function',
            updateRegistrationSummary: typeof window.updateRegistrationSummary === 'function'
        });
    });
    
    // SUPER CRITICAL FIX FOR DISAPPEARING BUTTONS:
    // This is a comprehensive fix that will ensure ALL buttons remain visible ALWAYS
    // It runs very frequently and forces the display to be visible
    setInterval(function() {
        const currentStep = window.registerApp ? window.registerApp.currentStep : 4;
        
        // Find all navigation buttons
        const nextButton = document.getElementById('nextButton');
        const prevButton = document.getElementById('prevButton');
        const fixedNextButton = document.getElementById('fixedNextButton');
        const fixedPrevButton = document.getElementById('fixedPrevButton');
        
        // Make next button always visible
        if (nextButton) {
            if (nextButton.style.display !== 'block') {
                console.log("CRITICAL FIX: Next button was hidden, forcing visible");
                nextButton.style.display = 'block';
                
                // Force browser to recognize style change
                window.getComputedStyle(nextButton).display;
            }
            
            // Also ensure correct text
            if (currentStep === 4) {
                nextButton.textContent = 'Save';
                nextButton.classList.add('btn-success');
                nextButton.classList.remove('btn-primary');
            }
        }
        
        // Make prev button visible except on first step
        if (prevButton && currentStep > 1) {
            if (prevButton.style.display !== 'block') {
                console.log("CRITICAL FIX: Prev button was hidden, forcing visible");
                prevButton.style.display = 'block';
                
                // Force browser to recognize style change
                window.getComputedStyle(prevButton).display;
            }
        }
        
        // Make fixed buttons visible on step 4
        if (currentStep === 4) {
            if (fixedNextButton && fixedNextButton.style.display !== 'block') {
                console.log("CRITICAL FIX: Fixed next button was hidden, forcing visible");
                fixedNextButton.style.display = 'block';
                fixedNextButton.textContent = 'Save';
                fixedNextButton.classList.add('btn-success');
                
                // Force browser to recognize style change
                window.getComputedStyle(fixedNextButton).display;
            }
            
            if (fixedPrevButton && fixedPrevButton.style.display !== 'block') {
                console.log("CRITICAL FIX: Fixed prev button was hidden, forcing visible");
                fixedPrevButton.style.display = 'block';
                
                // Force browser to recognize style change
                window.getComputedStyle(fixedPrevButton).display;
            }
        }
        
        // Also check the form navigation container
        const formNavigation = document.querySelector('.form-navigation');
        if (formNavigation && formNavigation.style.display === 'none') {
            console.log("CRITICAL FIX: Form navigation was hidden, forcing visible");
            formNavigation.style.display = 'block';
            
            // Force browser to recognize style change
            window.getComputedStyle(formNavigation).display;
        }
    }, 250); // Run very frequently (4 times per second)
</script>

<!-- Global supplier data from backend -->
<script>
    window.suppliers = {{ suppliers|tojson }};
</script>
{% endblock %}